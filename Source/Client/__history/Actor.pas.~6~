unit Actor;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  Grobal2, AbstractCanvas, AbstractTextures, CliUtil, magiceff, Wil, ClFunc,
  StallSystem, uGameEngine;

const
  MAXACTORSOUND = 3;
  CMMX = 150;
  CMMY = 200;
  HUMANFRAME = 600;
  MONFRAME = 280;
  EXPMONFRAME = 360;
  SCULMONFRAME = 440;
  ZOMBIFRAME = 430;
  MERCHANTFRAME = 60;
  MAXSAY = 5;
  RUN_MINHEALTH = 10;
  DEFSPELLFRAME = 10;
  FIREHIT_READYFRAME = 6;
  MAGBUBBLEBASE = 3890;
  MAGBUBBLESTRUCKBASE = 3900;
  MAXWPEFFECTFRAME = 5;
  WPEFFECTBASE = 3750;
  EFFECTBASE = 0;
  CELESTIALBASE = 1890;          //先天气功效果图位置
  CELESTIALSTRUCKBASE = 1893;    //被攻击时先天气功效果图位置
  BLOODDRAGONSWORDBASE = 190;  //血龙剑法

type
  TActionInfo = record
    start: word;              // 开始帧
    frame: word;              // 帧数
    skip: word;              // 跳过的帧数
    ftime: word;              // 每帧的延迟时间（毫秒）
    usetick: byte;              // 专用，仅用于移动动作
  end;

  PTActionInfo = ^TActionInfo;

   //玩家的动作定义
  THumanAction = record
    ActStand: TActionInfo;   //1
    ActWalk: TActionInfo;   //8
    ActRun: TActionInfo;   //8
    ActRushLeft: TActionInfo;
    ActRushRight: TActionInfo;
    ActWarMode: TActionInfo;   //1
    ActHit: TActionInfo;   //6
    ActHeavyHit: TActionInfo;   //6
    ActBigHit: TActionInfo;   //6
    ActFireHitReady: TActionInfo; //6
    ActSpell: TActionInfo;   //6
    ActSitdown: TActionInfo;   //1
    ActStruck: TActionInfo;   //3
    ActDie: TActionInfo;   //4
    ActFlareHit:   TActionInfo;   //1
  end;

  PTHumanAction = ^THumanAction;

  TMonsterAction = record
    ActStand: TActionInfo;   //1
    ActWalk: TActionInfo;   //8
    ActAttack: TActionInfo;   //6
    ActCritical: TActionInfo;   //6
    ActStruck: TActionInfo;   //3
    ActDie: TActionInfo;   //4
    ActDeath: TActionInfo;
  end;

  PTMonsterAction = ^TMonsterAction;

const
   //人类动作定义
   //每个人物每个级别每个性别共600幅图
   //设级别=L，性别=S，则开始帧=L*600+600*S

   //Start:该动作在这组外观下的开始帧
   //frame:该动作需要的帧数
   //skip:跳过的帧数
  HA: THumanAction = (//开始帧       有效帧     跳过帧    每帧延迟
    ActStand: (
    start: 0;
    frame: 4;
    skip: 4;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 90;
    usetick: 2
  );
    ActRun: (
    start: 128;
    frame: 6;
    skip: 2;
    ftime: 120;
    usetick: 3
  );
    ActRushLeft: (
    start: 128;
    frame: 3;
    skip: 5;
    ftime: 120;
    usetick: 3
  );
    ActRushRight: (
    start: 131;
    frame: 3;
    skip: 5;
    ftime: 120;
    usetick: 3
  );
    ActWarMode: (
    start: 192;
    frame: 1;
    skip: 0;
    ftime: 200;
    usetick: 0
  );
        //ActHit:    (start: 200;    frame: 5;  skip: 3;  ftime: 140;  usetick: 0);
    ActHit: (
    start: 200;
    frame: 6;
    skip: 2;
    ftime: 85;
    usetick: 0
  );
    ActHeavyHit: (
    start: 264;
    frame: 6;
    skip: 2;
    ftime: 90;
    usetick: 0
  );
    ActBigHit: (
    start: 328;
    frame: 8;
    skip: 0;
    ftime: 70;
    usetick: 0
  );
    ActFireHitReady: (
    start: 192;
    frame: 6;
    skip: 4;
    ftime: 70;
    usetick: 0
  );
    ActSpell: (
    start: 392;
    frame: 6;
    skip: 2;
    ftime: 60;
    usetick: 0
  );
    ActSitdown: (
    start: 456;
    frame: 2;
    skip: 0;
    ftime: 300;
    usetick: 0
  );
    ActStruck: (
    start: 472;
    frame: 3;
    skip: 5;
    ftime: 70;
    usetick: 0
  );
    ActDie: (
    start: 536;
    frame: 4;
    skip: 4;
    ftime: 120;
    usetick: 0
  );
    ActFlareHit:(
     start: 200;
     frame: 3;
     skip: 5;
     ftime: 20;
     usetick: 0)
  );
  MA9: TMonsterAction =(  //足球
    ActStand: (
    start: 0;
    frame: 1;
    skip: 7;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 120;
    usetick: 3
  );
    ActAttack: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 1;
    skip: 7;
    ftime: 140;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 1;
    skip: 7;
    ftime: 0;
    usetick: 0
  );

  );
  MA10: TMonsterAction =(  //带刀卫士(8Frame楼府)
        //每个动作8帧    //从这里可以推测出怪物有几种？//这里是280的
    ActStand: (
    start: 0;
    frame: 4;
    skip: 4;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 120;
    usetick: 3
  );
    ActAttack: (
    start: 128;
    frame: 4;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 192;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 208;
    frame: 4;
    skip: 4;
    ftime: 140;
    usetick: 0
  );
    ActDeath: (
    start: 272;
    frame: 1;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA11: TMonsterAction =(  //荤娇(10Frame楼府) //每个动作10帧 //280,(360的),440,430,,
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 3
  );
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 140;
    usetick: 0
  );
    ActDeath: (
    start: 340;
    frame: 1;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA12: TMonsterAction =(  //版厚捍, 锭府绰 加档 狐福促.//每个动作8帧，每个动作8个方向，共7种动作 (280),360,440,430,,
    ActStand: (
    start: 0;
    frame: 4;
    skip: 4;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 120;
    usetick: 3
  );
    ActAttack: (
    start: 128;
    frame: 6;
    skip: 2;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 192;
    frame: 2;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 208;
    frame: 4;
    skip: 4;
    ftime: 160;
    usetick: 0
  );
    ActDeath: (
    start: 272;
    frame: 1;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA13: TMonsterAction =(  //食人花
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 10;
    frame: 8;
    skip: 2;
    ftime: 160;
    usetick: 0
  ); //殿厘...
    ActAttack: (
    start: 30;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //actattack从30开始是从各个方位攻击的效果
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 110;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  ); //受伤110开始，，
    ActDie: (
    start: 130;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  ); //130开始死亡效果
    ActDeath: (
    start: 20;
    frame: 9;
    skip: 0;
    ftime: 150;
    usetick: 0
  ); //20开始是食人花消隐的效果也是它死亡效果所以在这重用，，只有9帧最后一帧略去
  );
  MA14: TMonsterAction =(  //mon3里面的骷髅战士,,分析方法同ma13
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 340;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  ); //归榜牢版快(家券)
  );
  MA15: TMonsterAction =(  //沃玛战土
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 1;
    frame: 1;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
  );
  MA16: TMonsterAction =(  //啊胶筋绰 备单扁 mon5里面的电僵尸？？代表可移动的魔法攻击动作的怪物一类??
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 4;
    skip: 6;
    ftime: 160;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 1;
    skip: 0;
    ftime: 160;
    usetick: 0
  );
  );
  MA17: TMonsterAction =(  //官迭波府绰 各 mon6中的和尚僵王（和石墓尸王共用一形象）
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 60;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDeath: (
    start: 340;
    frame: 1;
    skip: 0;
    ftime: 140;
    usetick: 0
  ); //
  );
  MA19: TMonsterAction =(  //快搁蓖 (磷绰芭 弧府磷澜)
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 140;
    usetick: 0
  );
    ActDeath: (
    start: 340;
    frame: 1;
    skip: 0;
    ftime: 140;
    usetick: 0
  ); //
  );
  MA20: TMonsterAction =(  //磷菌促 混酒唱绰 粱厚)
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDeath: (
    start: 340;
    frame: 10;
    skip: 0;
    ftime: 200{怪物复活动作间隔 越大越慢 170是官方时间};
    usetick: 0
  ); //促矫 混酒唱扁
  );
  MA21: TMonsterAction =(  //国笼
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  ); //
    ActAttack: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //国 惯荤
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 20;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 30;
    frame: 10;
    skip: 0;
    ftime: 160;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  ); //
  );
  MA22: TMonsterAction =(  //籍惑阁胶磐(堪家措厘,堪家厘焙)
    ActStand: (
    start: 80;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 240;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  ); //
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 320;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 340;
    frame: 10;
    skip: 0;
    ftime: 160;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 6;
    skip: 4;
    ftime: 170;
    usetick: 0
  ); //籍惑踌澜
  );
  MA23: TMonsterAction =(  //林付空
    ActStand: (
    start: 20;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 100;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 180;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  ); //
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 260;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 280;
    frame: 10;
    skip: 0;
    ftime: 160;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 20;
    skip: 0;
    ftime: 100;
    usetick: 0
  ); //籍惑踌澜
  );
  MA24: TMonsterAction =(  //傈哎, 傍拜 2啊瘤
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 240;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActStruck: (
    start: 320;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 340;
    frame: 10;
    skip: 0;
    ftime: 140;
    usetick: 0
  );
    ActDeath: (
    start: 420;
    frame: 1;
    skip: 0;
    ftime: 140;
    usetick: 0
  ); //
  );
  MA25: TMonsterAction =(  //瘤匙空
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 70;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //殿厘
    ActAttack: (
    start: 20;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //流立傍拜
    ActCritical: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //刀魔傍拜(盔芭府)
    ActStruck: (
    start: 50;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 60;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 0
  );
    ActDeath: (
    start: 80;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //
  );
  MA26: TMonsterAction =(  //己巩,
    ActStand: (
    start: 0;
    frame: 1;
    skip: 7;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 160;
    usetick: 0
  ); //殿厘...
    ActAttack: (
    start: 56;
    frame: 6;
    skip: 2;
    ftime: 500;
    usetick: 0
  ); //凯扁
    ActCritical: (
    start: 64;
    frame: 6;
    skip: 2;
    ftime: 500;
    usetick: 0
  ); //摧扁
    ActStruck: (
    start: 0;
    frame: 4;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 24;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 150;
    usetick: 0
  ); //见澜..
  );
  MA27: TMonsterAction =(  //己寒
    ActStand: (
    start: 0;
    frame: 1;
    skip: 7;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 160;
    usetick: 0
  ); //殿厘...
    ActAttack: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 250;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 250;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 150;
    usetick: 0
  ); //见澜..
  );
  MA28: TMonsterAction =(  //脚荐 (函脚 傈)
    ActStand: (
    start: 80;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 0;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  ); //殿厘..
  );
  MA29: TMonsterAction =(  //脚荐 (函脚 饶)
    ActStand: (
    start: 80;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 3
  ); //
    ActAttack: (
    start: 240;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActStruck: (
    start: 320;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 340;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  ); //殿厘..
  );
  MA30: TMonsterAction =(  //趋芭牢空, 缴厘, 利岿付
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //
    ActAttack: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //傍拜汽
    ActCritical: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //
    ActStruck: (
    start: 20;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 30;
    frame: 20;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //
  );
  MA31: TMonsterAction =(  //气救芭固
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //
    ActAttack: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //傍拜汽
    ActCritical: (
    start: 0;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //
    ActStruck: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 20;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //
  );
  MA32: TMonsterAction =(  //气林
    ActStand: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 6;
    skip: 4;
    ftime: 200;
    usetick: 3
  ); //
    ActAttack: (
    start: 0;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //傍拜汽
    ActCritical: (
    start: 0;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //
    ActStruck: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 80;
    frame: 10;
    skip: 0;
    ftime: 80;
    usetick: 0
  );
    ActDeath: (
    start: 80;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 3
  ); //
  );
  MA33: TMonsterAction =(  //汾趋荤, 空吝居 (林付夯空), 空捣
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 200;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //傍拜汽
    ActCritical: (
    start: 340;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 0
  );
    ActDeath: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 200;
    usetick: 0
  ); //
  );
   // 2003/02/11
  MA34: TMonsterAction =(  //秦榜馆空
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 200;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //傍拜汽
    ActCritical: (
    start: 320;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  ); //
    ActStruck: (
    start: 400;
    frame: 2;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 420;
    frame: 20;
    skip: 0;
    ftime: 200;
    usetick: 0
  );
    ActDeath: (
    start: 420;
    frame: 20;
    skip: 0;
    ftime: 200;
    usetick: 0
  ); //
  );

  MA39: TMonsterAction =(  //NPC
    ActStand: (
    start: 0;
    frame: 11;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 3
  );
    ActAttack: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
  );
  MA50: TMonsterAction =(  //老馆 NPC
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 30;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 0;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA51: TMonsterAction = (
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 30;
    frame: 20;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 0;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA52: TMonsterAction =(  //
    ActStand: (
    start: 30;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 30;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 0;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
   // 2003/07/15 眠啊等 苞芭厚玫 各
  MA53: TMonsterAction =(  //苞芭 厚玫 版厚捍, 锭府绰 加档 狐福促.
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA54: TMonsterAction =(  //付拌籍
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 300;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 20;
    frame: 2;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 30;
    frame: 10;
    skip: 0;
    ftime: 80;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA55: TMonsterAction =(  //坷付菩空
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 250;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 210;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 110;
    usetick: 0
  ); //傍拜汽
    ActCritical: (
    start: 580;
    frame: 20;
    skip: 0;
    ftime: 135;
    usetick: 0
  ); //
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 20;
    skip: 0;
    ftime: 130;
    usetick: 0
  );
    ActDeath: (
    start: 260;
    frame: 20;
    skip: 0;
    ftime: 130;
    usetick: 0
  ); //
  );
  MA56: TMonsterAction =( //籍惑
    ActStand: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
    ActAttack: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 200;
    usetick: 0
  );
  );
  MA57: TMonsterAction =(  // 档柄厚阂, 采传
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 10;
    frame: 8;
    skip: 2;
    ftime: 160;
    usetick: 0
  ); //殿厘...
    ActAttack: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
//        ActDie:    (start: 30;     frame: 20; skip: 0;  ftime: 120;  usetick: 0); //采传
//        ActDeath:  (start: 30;     frame: 20; skip: 0;  ftime: 150;  usetick: 0);
    ActDie: (
    start: 30;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  ); //档柄厚阂
    ActDeath: (
    start: 30;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  ); //见澜..
  );
  MA58: TMonsterAction =(  // 岿飞(玫赤)
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 0
  );
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 0
  );
    ActCritical: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 160;
    usetick: 0
  ); // SM_LIGHTING(付过荤侩=>碍拜) 锭 静烙
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 340;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
  );
  MA59: TMonsterAction =(  // FireDragon (拳锋)
    ActStand: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 300;
    usetick: 0
  );
    ActWalk: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActAttack: (
    start: 20;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 40;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActStruck: (
    start: 40;
    frame: 2;
    skip: 8;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 30;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA60: TMonsterAction =(  // 侩炼脚惑 (侩籍惑)
    ActStand: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 300;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 300;
    usetick: 0
  );
    ActAttack: (
    start: 10;
    frame: 10;
    skip: 0;
    ftime: 300;
    usetick: 0
  );
    ActCritical: (
    start: 10;
    frame: 10;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 300;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 300;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 300;
    usetick: 0
  );
  );
  MA61: TMonsterAction =( // 付锋狼傈阿 阂采NPC
    ActStand: (
    start: 0;
    frame: 20;
    skip: 0;
    ftime: 100;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  MA62: TMonsterAction =(  //汲牢措面,林付拜汾厘,券康茄龋, 芭固(脚籍刀付林)
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 250;
    usetick: 0
  );
    ActWalk: (
    start: 80;
    frame: 6;
    skip: 4;
    ftime: 100;
    usetick: 3
  ); //
    ActAttack: (
    start: 160;
    frame: 6;
    skip: 4;
    ftime: 110;
    usetick: 0
  );
    ActCritical: (
    start: 340;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActStruck: (
    start: 240;
    frame: 2;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDie: (
    start: 260;
    frame: 10;
    skip: 0;
    ftime: 90;
    usetick: 0
  );
    ActDeath: (
    start: 420;
    frame: 1;
    skip: 0;
    ftime: 140;
    usetick: 0
  ); //
  );
  MA63: TMonsterAction =(  //焊拱窃
    ActStand: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 1000;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 1000;
    usetick: 0
  );
    ActAttack: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 1000;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 2;
    skip: 8;
    ftime: 1000;
    usetick: 0
  );
    ActStruck: (
    start: 10;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 20;
    frame: 2;
    skip: 8;
    ftime: 1000;
    usetick: 0
  );
    ActDeath: (
    start: 20;
    frame: 2;
    skip: 8;
    ftime: 1000;
    usetick: 0
  );
  );
  MA64: TMonsterAction =(  //龋去籍(鞘靛)
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 10;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  ); //殿厘...
    ActAttack: (
    start: 20;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  );
    ActCritical: (
    start: 20;
    frame: 6;
    skip: 4;
    ftime: 120;
    usetick: 0
  );
    ActStruck: (
    start: 30;
    frame: 2;
    skip: 8;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 40;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  );
    ActDeath: (
    start: 40;
    frame: 10;
    skip: 0;
    ftime: 120;
    usetick: 0
  ); //见澜..
  );
  MA65: TMonsterAction =(  //龋扁楷
    ActStand: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActWalk: (
    start: 10;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActAttack: (
    start: 20;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 20;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActStruck: (
    start: 30;
    frame: 4;
    skip: 6;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 40;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActDeath: (
    start: 40;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
  );
  MA66: TMonsterAction =(  //厚岿玫林
    ActStand: (
    start: 0;
    frame: 20;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 20;
    skip: 0;
    ftime: 150;
    usetick: 3
  );
    ActAttack: (
    start: 20;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 20;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActStruck: (
    start: 30;
    frame: 2;
    skip: 8;
    ftime: 100;
    usetick: 0
  );
    ActDie: (
    start: 400;
    frame: 18;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActDeath: (
    start: 400;
    frame: 18;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
  );
  MA67: TMonsterAction =(  //龋去扁籍
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 3
  );
    ActAttack: (
    start: 10;
    frame: 4;
    skip: 6;
    ftime: 300;
    usetick: 0
  );
    ActCritical: (
    start: 10;
    frame: 4;
    skip: 6;
    ftime: 300;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 300;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 300;
    usetick: 0
  );
  );
  MA68: TMonsterAction =(  //NPC 3规氢 辑乐扁 葛记父
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 3
  );
    ActAttack: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
  );
  MA69: TMonsterAction =(  //侗
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActAttack: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 150;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 10;
    skip: 0;
    ftime: 150;
    usetick: 0
  );
    ActStruck: (
    start: 10;
    frame: 2;
    skip: 8;
    ftime: 150;
    usetick: 0
  );
    ActDie: (
    start: 20;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
    ActDeath: (
    start: 20;
    frame: 6;
    skip: 4;
    ftime: 150;
    usetick: 0
  );
  );
  MA70: TMonsterAction =(  //
    ActStand: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActWalk: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActAttack: (
    start: 0;
    frame: 4;
    skip: 6;
    ftime: 200;
    usetick: 0
  );
    ActCritical: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActStruck: (
    start: 0;
    frame: 1;
    skip: 9;
    ftime: 0;
    usetick: 0
  );
    ActDie: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
    ActDeath: (
    start: 0;
    frame: 0;
    skip: 0;
    ftime: 0;
    usetick: 0
  );
  );
  WORDER: array[0..1, 0..599] of byte =(  //1: 女,  0: 男
    (       //男
      //站
    0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1,      //走
    0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1,      //跑
    0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1,      //war葛靛
    0, 1, 1, 1, 0, 0, 0, 0,      //击
    1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1,      //击 2
    0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1,      //击 3
    1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0,      //付过
    0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1,      //乇
    0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0,      //嘎扁
    0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1,      //静矾咙
    0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1),
(      //沥瘤
  0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1,      //叭扁
  0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1,      //顿扁
  0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1,      //war葛靛
  1, 1, 1, 1, 0, 0, 0, 0,      //傍拜
  1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1,      //傍拜 2
  0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1,      //傍拜3
  1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0,      //付过
  0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1,      //乇
  0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0,      //嘎扁
  0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1,      //静矾咙
  0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1));
  EffDir: array[0..7] of byte = (0, 0, 1, 1, 1, 1, 1, 0);

type
  TActor = class
    RecogId: integer;
    XX: word;
    YY: word;
    Dir: byte;
    Sex: byte;
    Race: byte;
    Hair: byte;
    Dress: byte;
    Weapon: byte;
    Effect: byte; //天使类型 翅膀
    Job: byte; //职业 0:武士  1:法师  2:道士
    AttackMode: byte; //攻击模式
    Appearance: word;
//      DeathState: byte;
    Feature: integer;
    FeatureEx: integer;   //翅膀增加
    bUpdateShowTrans: Boolean;
    bShowTrans: Byte;//0不显示  1显示
    State: integer;
    Death: Boolean;
    Skeleton: Boolean;
    BoDelActor: Boolean;
    BoDelActionAfterFinished: Boolean;
    DescUserName: string;  //人物名称，后缀
    FameName: string;
    UserName: string; //名字
    NameColor: integer; //名字颜色
    Abil: TAbility;
    Gold: integer;
    GamePoint: integer;
    PlayCash: integer;
    m_btCreditPoint: integer;
    HitSpeed: shortint; //攻击速度0：基本，（-）慢（+）快
    Visible: Boolean;
    BoHoldPlace: Boolean;
    Saying: array[0..MAXSAY - 1] of string;  //最近说的话
    SayWidths: array[0..MAXSAY - 1] of integer;  //每句话的宽度
    SayTime: longword;
    SayX, SayY: integer;
    SayLineCount: integer;
    ShiftX: integer;
    ShiftY: integer;
    px: integer;
    py: integer;
    Rx, Ry: integer;
    DownDrawLevel: integer;  //之前绘制了几个单元格。
    TargetX, TargetY: integer; //在怪物的情况下，进行投掷攻击时的命中位置
    TargetRecog: integer; //
    HiterCode: integer;
    MagicNum: integer;
    CurrentEvent: integer; //服务器上的事件ID
    BoDigFragment: Boolean;  //鹤嘴锄的品质是开采出来的吗？..
    BoThrow: Boolean;
    BodyOffset, HairOffset, WingOffset, WeaponOffset, WeaponEffectOffset: integer;
    BoUseMagic: Boolean;
    BoHitEffect: Boolean;
    BoUseEffect: Boolean;  //是否使用效果..
    HitEffectNumber: integer;
    WaitMagicRequest: longword;
    WaitForRecogId: integer;  //当它消失时，WaitFor 的 actor 变得可见。
    WaitForFeature: integer;
    WaitForStatus: integer;
      //BoEatEffect: Boolean;  //吃药的效果
      //EatEffectFrame: integer;
      //EatEffectTime: longword;

    CurEffFrame: integer;
    SpellFrame: integer; //魔法的施法效果
    CurMagic: TUseMagicInfo;
      //GlimmingMode: Boolean;
      //CurGlimmer: integer;
      //MaxGlimmer: integer;
      //GlimmerTime: longword;
    GenAniCount: integer;
    BoOpenHealth: Boolean;
    BoInstanceOpenHealth: Boolean;
    OpenHealthStart: longword;
    OpenHealthTime: integer;
    OpenStruck: boolean;
    BoOpenStruckHealth: Boolean;
    OpenStruckStart: LongWord;
    OpenStruckTime: integer;
      //SRc: TRect;  //Screen Rect 屏幕上的实际坐标（基于鼠标）
    BodySurface: TAsphyreLockableTexture;
    Grouped: Boolean; //我和我的小组
    CurrentAction: integer;
    ReverseFrame: Boolean;
    WarMode: Boolean;
    WarModeTime: longword;
    WarModeCount: Integer;
    WarMode2: Boolean;
    ChrLight: integer;
    MagLight: integer;
    RushDir: integer;  //0, 1 一次是左边一次是右边。

    WalkFrameDelay: integer;  //默认值为客户端的ftime。
                                //从服务器接收时，使用从服务器接收的值。

    LockEndFrame: Boolean;
    LastStruckTime: longword;
    SendQueryUserNameTime: longword;
    DeleteTime: longword;

      //声音效果
    MagicStruckSound: integer;
    borunsound: Boolean;
    footstepsound: integer;  //如果你是主角， CM_WALK, CM_RUN
    strucksound: integer;  //挨打时发出的声音    SM_STRUCK
    struckweaponsound: integer;
    appearsound: integer;  //登场声 0
    normalsound: integer;  //一般声音 1
    attacksound: integer;  //         2
    weaponsound: integer; //          3
    screamsound: integer;  //         4
    diesound: integer;     //死亡时发出 5 声音    SM_DEATHNOW
    die2sound: integer;
    magicstartsound: integer;
    magicfiresound: integer;
    magicexplosionsound: integer;
    Bo50LevelEffect: Boolean;
    FoodStickType: integer;
//      BoWriterEffect: Boolean;
    TempState: byte; //飞越天柱现在状态
    BoFisrShopItem: Boolean;
    SpellGuideMode: boolean;
    SpellGuideModeTime: longword;
    revivalmode: boolean;
    revivalmodetime: integer;
  private
  protected
    startframe: integer;
    endframe: integer;
    currentframe: integer;
    effectstart: integer;
    effectframe: integer;
    effectend: integer;
    effectstarttime: longword;
    effectframetime: longword;
    frametime: longword;   //每帧时间
    starttime: longword;   //最后一帧的时间
    maxtick: integer;
    curtick: integer;
    movestep: integer;
    msgmuch: Boolean;
    struckframetime: longword;
    currentdefframe: integer;
    defframetime: longword;
    defframecount: integer;
    SkipTick, SkipTick2: integer;
    smoothmovetime: longword;
    genanicounttime: longword;
    loadsurfacetime: longword;
    oldx, oldy, olddir: integer;
    actbeforex, actbeforey: integer;  //行动前的坐标
    wpord: integer;
    procedure CalcActorFrame; dynamic;
    procedure DefaultMotion; dynamic;
    function GetDefaultFrame(wmode: Boolean): integer; dynamic;
    procedure DrawEffSurface(dsurface: TAsphyreCanvas; source: TAsphyreLockableTexture; ddx, ddy: integer; blend: Boolean; ceff: TColorEffect);
    procedure DrawWeaponGlimmer(dsurface: TAsphyreCanvas; ddx, ddy: integer);
  public
    MsgList: TList;       //list of PTChrMsg
    RealActionMsg: TChrMsg; //FrmMain 在中使用

    constructor Create; dynamic;
    destructor Destroy; override;
    procedure SendMsg(ident: word; x, y, cdir, feature, state: integer; str: string; sound: integer);
    procedure UpdateMsg(ident: word; x, y, cdir, feature, state: integer; str: string; sound: integer);
    procedure CleanUserMsgs;
    procedure ProcMsg;
    procedure ProcHurryMsg;
    function IsIdle: Boolean;
    function ActionFinished: Boolean;
    function CanWalk: Integer;
    function CanRun: Integer;
    function Strucked: Boolean;
    procedure Shift(dir, step, cur, max: integer);
    procedure ReadyAction(msg: TChrMsg);
    function CharWidth: Integer;
    function CharHeight: Integer;
    function CheckSelect(dx, dy: integer): Boolean;
    procedure CleanCharMapSetting(x, y: integer);
    procedure Say(str: string);
    procedure SetSound; dynamic;
    procedure Run; dynamic;
    procedure RunSound; dynamic;
    procedure RunActSound(frame: integer); dynamic;
    procedure RunFrameAction(frame: integer); dynamic;  //为每一帧做一些独特的事情
    procedure ActionEnded; dynamic;
    function Move(step: integer): Boolean;
    procedure MoveFail;
    function CanCancelAction: Boolean;
    procedure CancelAction;
    procedure FeatureChanged; dynamic;
    function Light: integer; dynamic;
    procedure LoadSurface; dynamic;
    function GetDrawEffectValue: TColorEffect;
    procedure DrawChr(dsurface: TAsphyreCanvas; dx, dy: integer; blend: Boolean; WingDraw: Boolean); dynamic;
    procedure DrawEff(dsurface: TAsphyreCanvas; dx, dy: integer); dynamic;
    function   ChickAppearance: integer;
  end;

  TNpcActor = class(TActor)
  private
      // 2003/07/15 添加了新的NPC
    ax, ay: integer;
    PlaySnow: Boolean;
    SnowStartTime: longword;
    EffectSurface: TAsphyreLockableTexture;
    PalySu: Boolean;
  public
    constructor Create; override;
    procedure Run; override;
    procedure CalcActorFrame; override;
    function GetDefaultFrame(wmode: Boolean): integer; override;
    procedure LoadSurface; override;
      // 2003/07/15 添加了新的NPC
    procedure DrawChr(dsurface: TAsphyreCanvas; dx, dy: integer; blend: Boolean; WingDraw: Boolean); override;
    procedure DrawEff(dsurface: TAsphyreCanvas; dx, dy: integer); override;
  end;

  THumActor = class(TActor)
  private
    HairSurface: TAsphyreLockableTexture;
    WeaponSurface: TAsphyreLockableTexture;
    WingSurface: TAsphyreLockableTexture;
    BoWeaponEffect: Boolean;  //武器升级成功，破碎效果
    CurWpEffect: integer;
    CurBubbleStruck: integer;
    wpeffecttime: longword;
    BoHideWeapon: Boolean;
    hpx, epx, epx2, epx3, epx4, wpx, wpx2: integer;
    hpy, epy, epy2, epy3, epy4, wpy, wpy2: integer;
    WingCurrentFrame: integer;
    WingStartTime: longword;
    WingFrameTime: longword;              // 帧数
      // 50Level Effect
    H50LevelEffectSurface: TAsphyreLockableTexture;
    H50LevelEffectOffset: integer;
    H50LevelEffectCurrentFrame: integer;
    H50LevelEffectStartTime: longword;
    H50LevelEffectFrameTime: longword;
    Bo50LevelHEffect: Boolean;

      // 巧克力棒 Event
    FoodStickDayEffectSurface: TAsphyreLockableTexture;
    FoodStickDayEffectSurface2: TAsphyreLockableTexture;
    FoodStickDayEffectOffset: integer;
    FoodStickDayEffectOffset2: integer;
    FoodStickDayEffectCurrentFrame: integer;
    FoodStickDayEffectStartTime: longword;
    FoodStickDayEffectFrameTime: longword;
    BoFoodStickDayEffect: Boolean;

      // Writer Effect
{      HWriterEffectSurface: TDirectDrawSurface;
      HWriterEffectOffset: integer;
      HWriterEffectCurrentFrame   : integer;
      HWriterEffectStartTime   : longword;
      HWriterEffectFrameTime   : longword;
      BoWriterHEffect: Boolean;}
      // 傍颇级
      SKillCurrentFrame: integer;
    SKillStartTime: longword;
    SKillFrameTime: longword;
      // 50LevelDress Effect
    Bo50DressHEffect: Boolean;
    WeaponEffectSurface: TAsphyreLockableTexture; //破冠真剑
    WeaponEffectCurrentFrame: integer;
    WeaponEffectStartTime: longword;
    WeaponEffectFrameTime: longword;
  protected
    procedure CalcActorFrame; override;
    procedure DefaultMotion; override;
    function GetDefaultFrame(wmode: Boolean): integer; override;
  public
      //
    m_StallMgr: TStallMgr; //
   //
    constructor Create; override;
    destructor Destroy; override;
    procedure Run; override;
    procedure RunFrameAction(frame: integer); override;
    function Light: integer; override;
    procedure LoadSurface; override;
    procedure DoWeaponBreakEffect;
    procedure DrawChr(dsurface: TAsphyreCanvas; dx, dy: integer; blend: Boolean; WingDraw: Boolean); override;
  end;

function RaceByPM(race, appr: integer): PTMonsterAction;

function GetMonImg(appr: integer): TWMImages;

function GetOffset(appr: integer): integer;

implementation

uses
  ClMain, SoundUtil, clEvent, MShare, NgShare, FState;

function RaceByPM(race, appr: integer): PTMonsterAction;
begin
  Result := nil;
  case race of   // 这里的Race被认为是RaceImg ... COPARK
    9:
      Result := @MA9;
    10:
      Result := @MA10;
    11:
      Result := @MA11;
    12, 24:
      Result := @MA12;
    13:
      Result := @MA13;
    14, 17, 18, 23:
      Result := @MA14;
    15, 22, 111, 112:
      Result := @MA15; //厚岿促农
    16:
      Result := @MA16;
    30, 31:
      Result := @MA17;
    19, 20, 21, 37,                        //厚刀芭固
    101, //归荤(没康荤)
    40, 45, 52, 53, 95, 113, 114, 116:  //摹面, 癌籍蓖荐
      Result := @MA19;
    41, 42:
      Result := @MA20;
    43:
      Result := @MA21;
    47:
      Result := @MA22;
    48, 49:
      Result := @MA23;
    32:
      Result := @MA24;  //傈哎, 傍拜捞 2啊瘤 规侥
    33:
      Result := @MA25;  //瘤匙空, 盟锋脚
    34, 90:
      Result := @MA30;  //趋芭牢空, 缴厘, 90=>拳锋个
    35:
      Result := @MA31;  //气救芭固
    36:
      Result := @MA32;  //气林
    54:
      Result := @MA28;
    55:
      Result := @MA29;  //脚荐(函脚饶)
    60, 61, 62:
      Result := @MA33;  //汾趋荤, 空捣, 林夯空(空吝空)
      // 2003/02/11
    63:
      Result := @MA34;
    64, 65, 66, 67, 68, 69, 102:    //扯牢蓖, 何侥蓖, 秦榜公厘, 秦榜捍凉, 秦榜公荤, 秦榜泵荐 眠啊
      Result := @MA19;
      // 2003/03/04
    70, 71, 72, 103, 104, 105, 117, 118:
      Result := @MA33;  //馆具快荤, 馆具谅荤, 荤快玫空, 癌枚蓖荐
      // 2003/07/15
    73:
      Result := @MA19;  // 朝俺坷付
    74:
      Result := @MA19;  // 艰苟摹惑鞭坷付, 根嫡捞惑鞭坷付, 漠窍鞭坷付, 档尝窍鞭坷付
    75:
      Result := @MA54;  // 付拌籍1
    76:
      Result := @MA53;  // 苞芭厚玫 版厚
    77:
      Result := @MA54;  // 付拌籍2
    78:
      Result := @MA55;  // 苞芭厚玫焊胶
    79:
      Result := @MA19;  // 劝窍鞭坷付
    80, 96:
      Result := @MA57;  // 青款狼瘤汾

    81:
      Result := @MA58;  // 岿飞
    83:
      Result := @MA59;  // 拳锋 FireDragon
    84, 85, 86, 87, 88, 89:
      Result := @MA60; // 侩炼脚惑

    91, 92, 93, 94:
      Result := @MA62;  // 2004/03/23 汲牢措面, 林付拜汾厘, 券康茄龋, 芭固(脚籍刀付林) 眠啊
    97:
      Result := @MA63;  // 焊拱窃

    98:
      Result := @MA27;
    99:
      Result := @MA26;

    100:
      Result := @MA62; // 炔陛捞公扁
    106:
      Result := @MA64; // 龋去籍
    107:
      Result := @MA67; // 龋去扁籍
    108, 109:
      Result := @MA65; // 龋扁楷
    110:
      Result := @MA66; // 厚岿玫林
    115:
      Result := @MA11; // 龋冠
    119:
      Result := @MA69; // 侗

    50:  //npc
      case appr of
        23:
          begin
            Result := @MA51;
          end;
            // 2003/07/15 苞芭厚玫 NPC
        27, 24, 25:
          begin
            Result := @MA52;
          end;
        30..45:
          begin
            Result := @MA70;
          end;
            {35..41, }        48, 49, 50, 52, 53, 54, 55, 57, 58, 60, 74, 78..80,83,84: // npc眠啊
          begin
            Result := @MA56; //籍惑
          end;
            {42,43,44,45,}        46, 47: // NewNpc
          begin
            Result := @MA61;
          end;
        56, 59, 68..73, 75..77:
          begin
            Result := @MA68; //辑乐扁 葛记父 乐绰巴甸
          end;

         171..180:
          begin
          Result := @MA39;  //11橇饭烙
          end;

      else
        Result := @MA50; //老馆 NPC
      end;
  end;
end;

function GetMonImg(appr: integer): TWMImages;
begin
  Result := WMonImg; //Default
  case (appr div 10) of
    0:
      Result := WMonImg;   //
    1:
      Result := WMon2Img;  //侥牢檬
    2:
      Result := WMon3Img;
    3:
      Result := WMon4Img;
    4:
      Result := WMon5Img;
    5:
      Result := WMon6Img;
    6:
      Result := WMon7Img;
    7:
      Result := WMon8Img;
    8:
      Result := WMon9Img;
    9:
      Result := WMon10Img;
    10:
      Result := WMon11Img;
    11:
      Result := WMon12Img;
    12:
      Result := WMon13Img;
    13:
      Result := WMon14Img;
    14:
      Result := WMon15Img;
    15:
      Result := WMon16Img;
    16:
      Result := WMon17Img;
    17:
      Result := WMon18Img;
    18:
      Result := WMon19Img;
      // 2003/02/11 脚痹 各 殿厘
    19:
      Result := WMon20Img;
      // 2003/03/04 脚痹 各 殿厘
    20:
      Result := WMon21Img;
      // 2003/07/15 苞芭 厚玫 眠啊各
    21:
      Result := WMon22Img;
    22:
      Result := WMon23Img;
    23:
      Result := WMon24Img;
    24:
      Result := WMon25Img;
    25:
      Result := WMon26Img;
    26:
      Result := WMon27Img;

    80:
      Result := WDragonImg; // FireDragon

    90:
      Result := WEffectImg;  //己巩, 己寒
  end;
end;

(* function GetOffset(appr: integer): integer;
var
  nrace, npos: integer;
begin
  Result := 0;
  nrace := appr div 10;
  npos := appr mod 10;
  case nrace of
    0:
      Result := npos * 280;  //8橇贰烙
    1:
      begin
        case npos of
          0, 1:
            Result := npos * 230;
          2:
            Result := 280;
          3:
            Result := 350; //龋冠
          4:
            Result := 700; //侗
          5:
            Result := 740; //龋困斑傍
          6:
            Result := 1100; //龋困斑傍
          7: Result := 1460;//牛
        end;
      end;
    2, 3, 7..12, 14..16:
      Result := npos * 360;  //10橇贰烙 扁夯

    13:
      case npos of
        1:
          Result := 360;   //利岿付 (缴厘)
        2:
          Result := 440;   //气救芭固 (决付芭固)
        3:
          Result := 550;   //气林(货尝芭固)
        4:
          Result := 750;   //捞亥飘 利岿付AI 盟锋脚
//               else Result := npos * 360;
      end;

    4:
      begin
        Result := npos * 360;        //
        if npos = 1 then
          Result := 600;  //厚阜盔面
      end;
    5:
      Result := npos * 430;   //粱厚
    6:
      Result := npos * 440;   //林付脚厘,龋过,空
    17:
      if npos = 2 then
        Result := 920 // 岿飞
      else
        Result := npos * 350;   //脚荐
    18:
      case npos of
        0:
          Result := 0;     //汾趋荤
        1:
          Result := 520;   //空捣
        2:
          Result := 950;   //林付夯空(空吝空)
      end;
      // 2003/02/11 脚痹 各 殿厘
    19:
      case npos of
        0:
          Result := 0;     //扯牢蓖
        1:
          Result := 370;   //何侥蓖
        2:
          Result := 810;   //秦榜公厘
        3:
          Result := 1250;   //秦榜捍凉
        4:
          Result := 1630;   //秦榜公荤
        5:
          Result := 2010;   //秦榜泵荐
        6:
          Result := 2390;   //秦榜馆空
      end;
      // 2003/03/04 脚痹 各 殿厘
    20:
      case npos of
        0:
          Result := 0;     //馆具蓖凉
        1:
          Result := 360;   //馆具葫蓖
        2:
          Result := 720;   //馆具款蓖
        3:
          Result := 1080;   //馆具浅蓖
        4:
          Result := 1440;   //馆具拳蓖
        5:
          Result := 1800;   //馆具快荤
        6:
          Result := 2350;   //馆具谅荤
        7:
          Result := 3060;   //荤快玫空
      end;
      // 2003/07/15 脚痹 各 殿厘
    21:
      case npos of
        0:
          Result := 0;     //朝俺坷付
        1:
          Result := 460;   //艰苟摹惑鞭坷付
        2:
          Result := 820;   //根嫡捞惑鞭坷付
        3:
          Result := 1180;  //漠窍鞭坷付
        4:
          Result := 1540;  //档尝窍鞭坷付
        5:
          Result := 1900;  //劝窍鞭坷付
        6:
          Result := 2260;  //芒版厚
        7:
          Result := 2440;  //付拌籍1
        8:
          Result := 2570;  //付拌籍2
        9:
          Result := 2700;  //苞芭厚玫焊胶
      end;
      // 2004/03/23 脚痹阁胶磐 眠啊
    22:
      case npos of
        0:
          Result := 0;     //汲牢措面
        1:
          Result := 430;   //林付拜汾厘
        2:
          Result := 1290;  //券康茄龋
        3:
          Result := 1810;  //芭固(脚籍刀付林)
        4:
          Result := 2320;  //炔陛捞公扁
        5:
          Result := 2920;  //归荤(没康荤)
        6:
          Result := 3270;  //趋刀炔荤
        7:
          Result := 3620;  //趋刀巢荤
        8:
          Result := 3970;  //岿靛呐 券康茄龋
      end;
    23:
      case npos of //2005/07/20 咯快带傈
        0:
          Result := 0;     //傈荤厚岿咯快
        1:
          Result := 440;   //贱荤厚岿咯快
        2:
          Result := 820;   //档荤厚岿咯快
        3:
          Result := 1360;  //龋去籍
        4:
          Result := 1420;  //龋去扁籍
        5:
          Result := 1450;  //龋扁楷(家)
        6:
          Result := 1560;  //龋扁楷(措)
        7:
          Result := 1670;  //厚岿玫林
        8:
          Result := 2270;  //厚岿促农(家)
        9:
          Result := 2700;  //厚岿促农(措)
      end;
    24:
      case npos of
        0:
          Result := 0;     //摹面(家)
        1:
          Result := 350;   //摹面(措)
        2:
          Result := 700;   //癌籍蓖荐
        3:
          Result := 1050;  //癌枚蓖荐
        4:
          Result := 1650;  //泅公泅脚
      end;

    80:
      case npos of // FireDragon
        0:
          Result := 0;     //拳锋
        1:
          Result := 80;    //拳锋个
        2:
          Result := 300;   //侩籍惑快惑
        3:
          Result := 301;   //侩籍惑快吝
        4:
          Result := 302;   //侩籍惑快窍
        5:
          Result := 320;   //侩籍谅快惑
        6:
          Result := 321;   //侩籍谅快吝
        7:
          Result := 322;   //侩籍谅快窍

      end;

    90:
      case npos of
        0:
          Result := 80;   //己巩
        1:
          Result := 168;
        2:
          Result := 184;
        3:
          Result := 200;
      end;
  end;
end;

function GetNpcOffset(appr: integer): integer;
begin
  case appr of
    0..22:
      Result := MERCHANTFRAME * appr;
    23:
      Result := 1380;
      // 2003/07/15 苞芭厚玫 NPC
    27:
      Result := 1620 + MERCHANTFRAME * (appr - 26) - 30;
    26, 28, 29, 30..32, 33..37, 38..45: // 41:付拌荐
      Result := 1620 + MERCHANTFRAME * (appr - 26);
//      30..32, 38..45,33..37: //
//         Result := 1620 + MERCHANTFRAME * (appr - 30);
//      42,43: //拳吩阂1,2
//         Result := 2580;
      {44,45,}    46, 47: //啪阂1,2,3,4
      Result := 2640;
    48, 49, 50: //48:拌窜 49:霸矫魄 50:何辑柳荐饭
      Result := 2700 + MERCHANTFRAME * (appr - 48);
    51: // 刮痹NPC(蓖脚)    //2004/05/27 50LevelQuest
      Result := 2880;
    52: //传荤恩  //npc眠啊
      Result := 2960;
    54: //快拱
      Result := 3070;
    55: //矫眉
      Result := 3130;
    56: //版厚捍
      Result := 3190;
    57: //瞒盔狼巩
      Result := 3250;
    58: //荤磊籍惑
      Result := 3270;
    59: //龋去扁籍npc
      Result := 3290;
    60: //秦榜矫眉-楷牢涅胶飘
      Result := 3330;
    61, 62, 63, 64: //厚岿脚傈 阂采 1,2,3,4
      Result := 3350;
    65: //葛蹿阂
      Result := 3430;
    66: //农府胶付胶飘府 2005/12/14
      Result := 3450;
    67: //捞具扁窍绰急盔
      Result := 3500;
    68: //急厘
      Result := 3570;
    69: //飘府焊绰急盔
      Result := 3610;
    70: //旧酒乐绰急盔(沥搁)
      Result := 3630;
    71: //旧酒乐绰急盔(哭率第)
      Result := 3650;
    72: //旧酒乐绰急盔(坷弗率第)
      Result := 3670;
    73: //老人
      Result := 3690;
    74: //白色乌龟
      Result := 3710;
    75: //老太婆
      Result := 3730;
    76: //野狼
      Result := 3770;
    77: //野狗
      Result := 3810;
    78: //小树
      Result := 3850;
    79: //倒
      Result := 3870;
    80: //氓厘
      Result := 3890;

  else
    Result := 1470 + MERCHANTFRAME * (appr - 24);
  end;
end;    *)

function GetOffset (appr: integer): integer;    //怪物补丁读取规则
var
   nrace, npos: integer;
begin
   Result := 0;
   nrace := appr div 10;
   npos := appr mod 10;
   case nrace of
      0:    Result := npos * 280;  //8框架
      1:    begin
      case npos of
               0,1: Result := npos * 230;
               2: Result := 280;
               3: Result := 350;//龋冠
               4: Result := 700;//侗
               5: Result := 740;//龋困斑傍
               6: Result := 1100;//龋困斑傍
               7: Result := 1460;//牛
            end;
            end;
      2, 3, 7..12, 14..16 :    Result := npos * 360;  //10橇贰烙 扁夯

      13:   case npos of
               1: Result := 360;   //利岿付 (缴厘)
               2: Result := 440;   //气救芭固 (决付芭固)
               3: Result := 550;   //气林(货尝芭固)
               4: Result := 750;   //捞亥飘 利岿付AI 盟锋脚
//               else Result := npos * 360;
            end;

      4:    begin
               Result := npos * 360;        //
               if npos = 1 then Result := 600;  //厚阜盔面
            end;
      5:    Result := npos * 430;   //粱厚
      6:    Result := npos * 440;   //林付脚厘,龋过,空
      17:   if npos = 2 then Result := 920 // 岿飞
            else Result := npos * 350;   //脚荐
      18:   case npos of           //魔龙系列怪
               0: Result := 0;     //汾趋荤
               1: Result := 520;   //空捣
               2: Result := 950;   //林付夯空(空吝空)
               3: Result := 1574;
               4: Result := 1934;
               5: Result := 2294;
               6: Result := 2654;
               7: Result := 3014;
            end;
      // 2003/02/11 脚痹 各 殿厘
      19:   case npos of
               0: Result := 0;     //扯牢蓖
               1: Result := 370;   //何侥蓖
               2: Result := 810;   //秦榜公厘
               3: Result := 1250;   //秦榜捍凉
               4: Result := 1630;   //秦榜公荤
               5: Result := 2010;   //秦榜泵荐
               6: Result := 2390;   //秦榜馆空
            end;
      // 2003/03/04 脚痹 各 殿厘
      20:   case npos of
               0: Result := 0;     //馆具蓖凉
               1: Result := 360;   //馆具葫蓖
               2: Result := 720;   //馆具款蓖
               3: Result := 1080;   //馆具浅蓖
               4: Result := 1440;   //馆具拳蓖
               5: Result := 1800;   //馆具快荤
               6: Result := 2350;   //馆具谅荤
               7: Result := 3060;   //荤快玫空
            end;
      // 2003/07/15 脚痹 各 殿厘
      21:   case npos of
               0: Result := 0;     //朝俺坷付
               1: Result := 460;   //艰苟摹惑鞭坷付
               2: Result := 820;   //根嫡捞惑鞭坷付
               3: Result := 1180;  //漠窍鞭坷付
               4: Result := 1540;  //档尝窍鞭坷付
               5: Result := 1900;  //劝窍鞭坷付
               6: Result := 2260;  //芒版厚
               7: Result := 2440;  //付拌籍1
               8: Result := 2570;  //付拌籍2
               9: Result := 2700;  //苞芭厚玫焊胶
            end;
      // 2004/03/23 脚痹阁胶磐 眠啊
      22:   case npos of
               0: Result := 0;     //汲牢措面
               1: Result := 430;   //林付拜汾厘
               2: Result := 1290;  //券康茄龋
               3: Result := 1810;  //芭固(脚籍刀付林)
               4: Result := 2320;  //炔陛捞公扁
               5: Result := 2920;  //归荤(没康荤)
               6: Result := 3270;  //趋刀炔荤
               7: Result := 3620;  //趋刀巢荤
               8: Result := 3970;  //岿靛呐 券康茄龋
            end;
      23:   case npos of //2005/07/20 咯快带傈
               0: Result := 0;     //傈荤厚岿咯快
               1: Result := 440;   //贱荤厚岿咯快
               2: Result := 820;   //档荤厚岿咯快
               3: Result := 1360;  //龋去籍
               4: Result := 1420;  //龋去扁籍
               5: Result := 1450;  //龋扁楷(家)
               6: Result := 1560;  //龋扁楷(措)
               7: Result := 1670;  //厚岿玫林
               8: Result := 2270;  //厚岿促农(家)
               9: Result := 2700;  //厚岿促农(措)
            end;
      24:   case npos of
               0: Result := 0;     //摹面(家)
               1: Result := 350;   //摹面(措)
               2: Result := 700;   //癌籍蓖荐
               3: Result := 1050;  //癌枚蓖荐
               4: Result := 1650;  //泅公泅脚
               5: Result := 3100;
               6: Result := 3450;
               7: Result := 3880;
               8: Result := 4230;
               9: Result := 4580;
            end;
      25:   case npos of
               0: Result := 0;
               1: Result := 510;
               2: Result := 1370;
               3: Result := 1720;
               4: Result := 2070;
               5: Result := 2740;
               6: Result := 3820;
               7: Result := 4170;
               8: Result := 3000;
               9: Result := 3810;
            end;
      26:   case npos of
               0: Result := 0;
               1: Result := 340;
               2: Result := 680;
               3: Result := 1190;
               4: Result := 2100;
               5: Result := 2740;
               6: Result := 3820;
               7: Result := 4170;
               8: Result := 3000;
               9: Result := 3810;
            end;

      80:   case npos of // FireDragon
               0: Result := 0;     //拳锋
               1: Result := 80;    //拳锋个
               2: Result := 300;   //侩籍惑快惑
               3: Result := 301;   //侩籍惑快吝
               4: Result := 302;   //侩籍惑快窍
               5: Result := 320;   //侩籍谅快惑
               6: Result := 321;   //侩籍谅快吝
               7: Result := 322;   //侩籍谅快窍

            end;

      90:   case npos of
               0: Result := 80;   //己巩
               1: Result := 168;
               2: Result := 184;
               3: Result := 200;
            end;
   end;
end;

function GetNpcOffset (appr: integer): integer;
begin
   case appr of
      0..22:
         Result := MERCHANTFRAME * appr;
      23:
         Result := 1380;
      // 2003/07/15 苞芭厚玫 NPC
      27, 32 :
         Result := 1620 + MERCHANTFRAME * (appr - 26) - 30;
      26,28,29,30,31,33,34,35..41: // 41:付拌荐
         Result := 1620 + MERCHANTFRAME * (appr - 26);
      42,43: //拳吩阂1,2
         Result := 2580;
      44,45,46,47: //啪阂1,2,3,4
         Result := 2640;
      48,49,50: //48:拌窜 49:霸矫魄 50:何辑柳荐饭
         Result := 2700 + MERCHANTFRAME * (appr - 48);
      51: // 刮痹NPC(蓖脚)    //2004/05/27 50LevelQuest
         Result := 2880;
      52: //传荤恩  //npc眠啊
         Result := 2960;
      54: //快拱
         Result := 3070;
      55: //矫眉
         Result := 3130;
      56: //版厚捍
         Result := 3190;
      57: //瞒盔狼巩
         Result := 3250;
      58: //荤磊籍惑
         Result := 3270;
      59: //龋去扁籍npc
         Result := 3290;
      60: //秦榜矫眉-楷牢涅胶飘
         Result := 3330;
      61,62,63,64: //厚岿脚傈 阂采 1,2,3,4
         Result := 3350;
      65: //葛蹿阂
         Result := 3430;
      66: //农府胶付胶飘府 2005/12/14
         Result := 3450;
      67: //捞具扁窍绰急盔
         Result := 3500;
      68: //急厘
         Result := 3570;
      69: //飘府焊绰急盔
         Result := 3610;
      70: //旧酒乐绰急盔(沥搁)
         Result := 3630;
      71: //旧酒乐绰急盔(哭率第)
         Result := 3650;
      72: //旧酒乐绰急盔(坷弗率第)
         Result := 3670;
      73: //老人
         Result := 3690;
      74: //白色乌龟
         Result := 3710;
      75: //老太婆
         Result := 3730;
      76: //野狼
         Result := 3770;
      77: //野狗
         Result := 3810;
      78: //小树
         Result := 3850;
      79: //倒
         Result := 3870;
      80: //氓厘
         Result := 3890;
      81: //撑雨伞美女
         Result := 3910;
//      84:                  //84 奇怪的老人
//         Result := 4040;
//      83:                  //85 古代月氏柱子
//         Result := 4110;
      83..85: Result := (Appr - 83) * 20 + 4110; //扁嫡 家龋NPC
      86:                  //86 失去光芒的柱子
         Result := 4130;
      87:                  //87 悲月素狐
         Result := 4150;
      88:                  //88 古代地图石碑
         Result := 4220;
      89:                  //89 古代石阁石碑
         Result := 4250;
      90:                  //90 漂泊的灵魂
         Result := 4280-30;
      91:                  //91 疑问的灵魂
         Result := 4350-30;
      92:                  //92
         Result := 4420-30;
      93:                  //93
         Result := 4460;
      94:                  //94 石像1
         Result := 4530;
      95:                  //95 石像2
         Result := 4560;
      96:                  //96
         Result := 4590;
      97:                  //97 叫唤地狱入口
         Result := 4610;
      98:                  //98
         Result := 4630;
      99:                  //99
         Result := 4650-30;
      100:                 //100 桃园看门人
         Result := 4690-30;
      101:                 //101
         Result := 4730-30;
      102:                 //102
         Result := 4770-30;
      103:                 //103 邮件管理员
         Result := 4810-30;
      104:
         Result := 4850-30;
      105:                //105 石像
         Result := 4890;
      106:                //106 石像
         Result := 4910;
      107:                //107 石像
         Result := 4930;
      108:                //108 石像
         Result := 4950;
      109:
         Result := 4970-30;
      110:
         Result := 5010-30;
      111:               //111
         Result := 5050;
//      110:               //纪念石碑
//         Result := 5070;
//      111:               //纪念石碑
//         Result := 5110;
      112:               //书桌
         Result := 5150;
      113:               //书柜
         Result := 5170;
      114:               //书柜
         Result := 5190;
      115:               //书柜
         Result := 5210;
      116:               //书柜
         Result := 5230;
      117:               //正确
         Result := 5250;
      118:
         Result := 5290-30;
      119:
         Result := 5330-30;
      120:
         Result := 5370;
      121:
         Result := 5390;
      122:
         Result := 5410-30;
         //新增加NPC
      123:
         Result := 5450-30;
      124:                //124
         Result := 5490-30;
      125:                //弓兵教官
         Result := 5530-30;
      126:
         Result := 5570;
      127:               //防守大将
         Result := 5610;
      128:               //进攻大将
         Result := 5680;
      129:               //旗帜正确
         Result := 5750;
      130:
         Result := 5770;
      131:
         Result := 5790;
      132:
         Result := 5810;
      133:
         Result := 5830;
      134:
         Result := 5850;
      135:
         Result := 5870;
      136:
         Result := 5890;
      137:
         Result := 5910;
      138:
         Result := 5930;
      139:
         Result := 5950;
      140:
         Result := 5970;
      141:
         Result := 5990;
      142:
         Result := 6010;
      143:
         Result := 6030;
      144:
         Result := 6050;
      145:
         Result := 6070;
      146:
         Result := 6090;
      147:                  //正确
         Result := 6110-30;
      148:                  //正确
         Result := 6150-30;
      149:                  //正确
         Result := 6190;
      150:                  //猫石像1
         Result := 6230;
      151:                  //猫石像2
         Result := 6250;
      152:                  //猫石像3
         Result := 6270;
      153:                  //猫石像4
         Result := 6290;
      154:                  //猫石像5
         Result := 6310;
      155:                  //猫石像6
         Result := 6330;
      156:                  //猫石像7
         Result := 6350;
      157:               // 书柜
         Result := 6370;
      158:
         Result := 6390-30;
      159:
         Result := 6430-30;
      160:
         Result := 6470;
      161:
         Result := 6490;
      162:               //以下全部正确
         Result := 6510;
      163:
         Result := 6540;
      164:
         Result := 6560;
      165:
         Result := 6580;
      166:
         Result := 6600;
      167:
         Result := 6620;
      168:
         Result := 6690;
      169:
         Result := 6710;
      170:
         Result := 6730-30;
     171..180: Result := (Appr - 171) * 30 + 6770; //标惯
      181:                  //6张3个面
         Result := 7070;
      182:                //10张图
         Result := 7110;
      183:                 //10张图
         Result := 7130;
      184:                //9张图
         Result := 7150;
      185:
         Result := 7190-30;
      186:
         Result := 7230;
      187:
         Result := 7270;
      188:
         Result := 7310;
      189:
         Result := 7350;
      190:
         Result := 7420;
      191:
         Result := 7490;
      192:
         Result := 7530;
      193:
         Result := 7570-30;
      194:
         Result := 7610-30;
      195:
         Result := 7650-30;
      196:
         Result := 7690-30;
      197:
         Result := 7730-30;
      198:
         Result := 7770-30;
      199:
         Result := 7810;
      200:
         Result := 7850;
      201:
         Result := 7870;
      202:
         Result := 7890;
      203:
         Result := 7960;
      204:
         Result := 8030;
      205:
         Result := 8100;
      206:
         Result := 8140;
      207..217:
         Result := 8180 + ((MERCHANTFRAME + 10) * (appr - 207));
      218:
         Result := 8950;
      219:
         Result := 8990;
      220:
         Result := 9030;
      221:               // 飞天时空石
         Result := 9070;
      222:               // 昆仑时空石
         Result := 9100;
      223:
         Result := 9130;
      224:
         Result := 9170;
      225:               // 昆仑守护石像
         Result := 9210;
      226:               // 神秘的石碑
         Result := 9230;
      227:               // 武林宗师石像
         Result := 9250;
      228:
         Result := 9270;
      229:
         Result := 9290;

      266: //农府胶付胶飘府 2005/12/14
         Result := 9400;

      else
         Result := 1470 + MERCHANTFRAME * (appr - 24);
   end;
end;

constructor TActor.Create;
begin
  inherited Create;
  MsgList := TList.Create;
  RecogId := 0;
  BodySurface := nil;
  FillChar(Abil, sizeof(TAbility), 0);
  Gold := 0;
  Visible := TRUE;
  BoHoldPlace := TRUE;

   //当前正在进行的动作，即使终止了也会拥有
   //如果动作的currentframe超出endframe，则视为动作已完成。
  CurrentAction := 0;
  ReverseFrame := FALSE;
  ShiftX := 0;
  ShiftY := 0;
  DownDrawLevel := 0;
  currentframe := -1;
  effectframe := -1;
  RealActionMsg.Ident := 0;
  UserName := '';
  NameColor := clWhite;
  SendQueryUserNameTime := 0; //GetTickCount;

  WarMode := FALSE;
  WarModeTime := 0;    //War mode更改为的时间
  WarModeCount := 4;
  WarMode2 := False;
  Death := FALSE;
  Skeleton := FALSE;
  BoDelActor := FALSE;
  BoDelActionAfterFinished := FALSE;

  ChrLight := 0;
  MagLight := 0;
  LockEndFrame := FALSE;
  smoothmovetime := 0; //GetTickCount;
  genanicounttime := 0;
  defframetime := 0;
  loadsurfacetime := GetTickCount;
  Grouped := FALSE;
  BoOpenHealth := FALSE;
  BoInstanceOpenHealth := FALSE;

  OpenStruck := False;
  BoOpenStruckHealth := FALSE;

  CurMagic.ServerMagicCode := 0;
   //CurMagic.MagicSerial := 0;

  SpellFrame := DEFSPELLFRAME;

  normalsound := -1;
  footstepsound := -1; //无 // 如果是主角, CM_WALK, CM_RUN
  attacksound := -1;
  weaponsound := -1;
  strucksound := s_struck_body_longstick;  //挨打时发出的声音    SM_STRUCK
  struckweaponsound := -1;
  screamsound := -1;
  diesound := -1;    //无 //死亡的声音    SM_DEATHNOW
  die2sound := -1;

//   BoWriterEffect := False;
  TempState := 1;
  FoodStickType := 0;
  BoFisrShopItem := True;
  bUpdateShowTrans := False;
end;

destructor TActor.Destroy;
begin
  MsgList.Free;
  inherited Destroy;
end;

procedure TActor.SendMsg(ident: word; x, y, cdir, feature, state: integer; str: string; sound: integer);
var
  pmsg: PTChrMsg;
begin
  new(pmsg);
  pmsg.ident := ident;
  pmsg.x := x;
  pmsg.y := y;
  pmsg.dir := cdir;
  pmsg.feature := feature;
  pmsg.state := state;
  pmsg.saying := str;
  pmsg.Sound := sound;
  MsgList.Add(pmsg);
end;

procedure TActor.UpdateMsg(ident: word; x, y, cdir, feature, state: integer; str: string; sound: integer);
var
  i, n: integer;
  pmsg: PTChrMsg;
begin
  if self = Myself then
  begin
    n := 0;
    while TRUE do
    begin
      if n >= MsgList.Count then
        break;
      if (PTChrMsg(MsgList[n]).ident >= 3000) and //客户端发来的信息。
        (PTChrMsg(MsgList[n]).ident <= 3099) or     //可以无视。
        (PTChrMsg(MsgList[n]).ident = ident) //什么都无视。
        then
      begin
        Dispose(PTChrMsg(MsgList[n]));
        MsgList.Delete(n);
      end
      else
        Inc(n);
    end;
    SendMsg(ident, x, y, cdir, feature, state, str, sound);
  end
  else
  begin
      //if not ((ident = SM_STRUCK) and (MsgList.Count >= 2)) then //正确动作省略
    if MsgList.Count > 0 then
    begin
      for i := 0 to MsgList.Count - 1 do
      begin
        if PTChrMsg(MsgList[i]).ident = ident then
        begin
          Dispose(PTChrMsg(MsgList[i]));
          MsgList.Delete(i);
          break;
        end;
      end;
    end;
    SendMsg(ident, x, y, cdir, feature, state, str, sound);
  end;
end;

procedure TActor.CleanUserMsgs;
var
  n: integer;
begin
  n := 0;
  while TRUE do
  begin
    if n >= MsgList.Count then
      break;
    if (PTChrMsg(MsgList[n]).ident >= 3000) and //客户端发送的消息是
      (PTChrMsg(MsgList[n]).ident <= 3099)     //你可以忽略它。
      then
    begin
      Dispose(PTChrMsg(MsgList[n]));
      MsgList.Delete(n);
    end
    else
      Inc(n);
  end;
end;

procedure TActor.CalcActorFrame;
var
  pm: PTMonsterAction;
  haircount: integer;
begin
  BoUseMagic := FALSE;
  currentframe := -1;
  WarModeCount := 4;
  BodyOffset := GetOffset(Appearance);
  pm := RaceByPM(race, Appearance);
  if pm = nil then
    exit;

  case CurrentAction of
    SM_TURN:
      begin
        startframe := pm.ActStand.start + Dir * (pm.ActStand.frame + pm.ActStand.skip);
        endframe := startframe + pm.ActStand.frame - 1;
        frametime := pm.ActStand.ftime;
        starttime := GetTickCount;
        defframecount := pm.ActStand.frame;
        Shift(Dir, 0, 0, 1);
      end;
    SM_WALK, SM_RUSH, SM_RUSHKUNG, SM_BACKSTEP:
      begin
        startframe := pm.ActWalk.start + Dir * (pm.ActWalk.frame + pm.ActWalk.skip);
        endframe := startframe + pm.ActWalk.frame - 1;
        frametime := WalkFrameDelay; //pm.ActWalk.ftime;
        starttime := GetTickCount;
        maxtick := pm.ActWalk.UseTick;
        curtick := 0;
        movestep := 1;
        if CurrentAction = SM_BACKSTEP then
          Shift(GetBack(Dir), movestep, 0, endframe - startframe + 1)
        else
          Shift(Dir, movestep, 0, endframe - startframe + 1);
      end;
      {SM_BACKSTEP:
         begin
            startframe := pm.ActWalk.start + (pm.ActWalk.frame - 1) + Dir * (pm.ActWalk.frame + pm.ActWalk.skip);
            endframe := startframe - (pm.ActWalk.frame - 1);
            frametime := WalkFrameDelay; //pm.ActWalk.ftime;
            starttime := GetTickCount;
            maxtick := pm.ActWalk.UseTick;
            curtick := 0;
            movestep := 1;
            Shift (GetBack(Dir), movestep, 0, endframe-startframe+1);
         end;}
    SM_HIT:
      begin
        startframe := pm.ActAttack.start + Dir * (pm.ActAttack.frame + pm.ActAttack.skip);
        endframe := startframe + pm.ActAttack.frame - 1;
        frametime := pm.ActAttack.ftime;
        starttime := GetTickCount;
            //WarMode := TRUE;
        WarModeTime := GetTickCount;
        Shift(Dir, 0, 0, 1);
      end;
    SM_STRUCK:
      begin
        startframe := pm.ActStruck.start + Dir * (pm.ActStruck.frame + pm.ActStruck.skip);
        endframe := startframe + pm.ActStruck.frame - 1;
        frametime := struckframetime; //pm.ActStruck.ftime;
        starttime := GetTickCount;
        Shift(Dir, 0, 0, 1);
      end;
    SM_DEATH:
      begin
        startframe := pm.ActDie.start + Dir * (pm.ActDie.frame + pm.ActDie.skip);
        endframe := startframe + pm.ActDie.frame - 1;
        startframe := endframe; //
        frametime := pm.ActDie.ftime;
        starttime := GetTickCount;
      end;
    SM_NOWDEATH:
      begin
        startframe := pm.ActDie.start + Dir * (pm.ActDie.frame + pm.ActDie.skip);
        endframe := startframe + pm.ActDie.frame - 1;
        frametime := pm.ActDie.ftime;
        starttime := GetTickCount;
      end;
    SM_SKELETON:
      begin
        startframe := pm.ActDeath.start + Dir;
        endframe := startframe + pm.ActDeath.frame - 1;
        frametime := pm.ActDeath.ftime;
        starttime := GetTickCount;
      end;
  end;
end;

procedure TActor.ReadyAction(msg: TChrMsg);
var
  i, n: integer;
  pmag: PTUseMagicInfo;
  gCheck: Boolean;
begin
  actbeforex := XX;
  actbeforey := YY;

{   if msg.Ident = SM_ALIVE then begin
      Death := FALSE;
      Skeleton := FALSE;
   end;}
  case msg.Ident of
    CM_SPELL:
      ;
  else    //OpenStruck := False;

  end;

  if not Death then
  begin
    case msg.Ident of
      SM_TURN, SM_WALK, SM_BACKSTEP, SM_RUSH, SM_RUSHKUNG, SM_RUN, SM_DIGUP, SM_ALIVE:
        begin
          feature := msg.feature;
          if msg.Ident <> SM_RUSH then
            state := msg.state;

               //显示角色的附加状态

          if state and STATE_OPENHEATH <> 0 then
            BoOpenHealth := TRUE //TRUE  不显示组队血条                // 2003/03/04 显示组队探测器
          else
          begin
            n := 0;
            for i := 1 to ViewListCount do
              if (ViewList[i].Index = RecogId) then
                n := i;
            if n = 0 then
              BoOpenHealth := FALSE;

          end;

        end;
    end;
//      if (msg.Ident = SM_DRAGON_FIRE1) or (msg.Ident = SM_DRAGON_FIRE2) or (msg.Ident = SM_DRAGON_FIRE3) or
//         (msg.Ident = SM_LIGHTING_1) then
    if msg.Ident in [SM_DRAGON_FIRE1, SM_DRAGON_FIRE2, SM_DRAGON_FIRE3, SM_LIGHTING_1..SM_LIGHTING_3] then
      n := 0;
    if msg.ident = SM_LIGHTING then
      n := 0;
    if Myself = self then
    begin
      if (msg.Ident = CM_WALK) then
        if not PlayScene.CanWalk(msg.x, msg.y) then
          exit;  //无法移动
      if (msg.Ident = CM_RUN) then
        if not PlayScene.CanRun(Myself.XX, Myself.YY, msg.x, msg.y) then
          exit; //无法移动
         //msg
      case msg.Ident of
        CM_TURN, CM_WALK, CM_SITDOWN, CM_RUN, CM_HIT, CM_POWERHIT, CM_LONGHIT, CM_WIDEHIT,            // 2003/03/15 新武功
        CM_CROSSHIT, CM_HEAVYHIT, CM_BIGHIT:
          begin
            RealActionMsg := msg; //当前正在执行的操作，向服务器发送消息。
            msg.Ident := msg.Ident - 3000;  //SM_?? 转换为
          end;
        CM_THROW:
          begin
            if feature <> 0 then
            begin
              TargetX := TActor(msg.feature).XX;  //x 投掷目标
              TargetY := TActor(msg.feature).YY;    //y
              TargetRecog := TActor(msg.feature).RecogId;
            end;
            RealActionMsg := msg;
            msg.Ident := SM_THROW;
          end;
        CM_FIREHIT:
          begin
            RealActionMsg := msg;
            msg.Ident := SM_FIREHIT;
          end;
            // 2003/07/15 新武功
        CM_TWINHIT:
          begin
            RealActionMsg := msg;
            msg.Ident := SM_TWINHIT;
          end;
        CM_SPELL:
          begin
            RealActionMsg := msg;
            pmag := PTUseMagicInfo(msg.feature);
            RealActionMsg.Dir := pmag.MagicSerial;
            msg.Ident := msg.Ident - 3000;  //SM_?? 转换为
          end;
      end;

      oldx := XX;
      oldy := YY;
      olddir := Dir;
    end;
    case msg.Ident of
      SM_STRUCK:
        begin
               //Abil.HP := msg.x; {HP}
               //Abil.MaxHP := msg.y; {maxHP}
               //msg.dir {damage}
               //等级高，挨打的时间短。
          MagicStruckSound := msg.x; //1以上，魔法效果
          n := Round(200 - Abil.Level * 5);
          if n > 80 then
            //struckframetime := 0
            struckframetime := n
          else
            struckframetime := 80;
          LastStruckTime := GetTickCount;
          gCheck := False;
          if GroupIdList.Count > 0 then
            for i := 0 to GroupIdList.Count - 1 do
            begin
              if integer(GroupIdList[i]) = HiterCode then
              begin
                gCheck := True;
                Break;
              end;
            end;
          if (race in [0, 55]) or ((Pos('(', UserName) > 0) and (Pos(')', UserName) > 0)) then
          begin
            if g_boMirShowHp then
            begin
              if not BoInstanceOpenHealth then
              begin
                BoInstanceOpenHealth := TRUE;
                OpenHealthTime := 60 * 1000;
                OpenHealthStart := GetTickCount;
              end;
            end
            else
            begin
              if g_bofuguHP and not g_boMirShowHp then
              begin
                if not BoInstanceOpenHealth then
                begin
                  BoInstanceOpenHealth := TRUE;
                  OpenHealthTime := 60 * 1000;
                  OpenHealthStart := GetTickCount;
                end;
              end;
            end;
          end
          else
          if ((race <> 0) and (race <> 34) and (HiterCode = Myself.RecogId) or gCheck) then
          begin   //MonOpenHp 攻击怪物显示血条
            if g_boMirShowHp then
            begin
              if not BoInstanceOpenHealth then
              begin
                BoInstanceOpenHealth := TRUE;
                OpenHealthTime := 60 * 1000;
                OpenHealthStart := GetTickCount;
              end;
            end
            else
            begin
              if g_bofuguHP and (Abil.MaxHP < 2000) and not g_boMirShowHp then
              begin
                if not BoInstanceOpenHealth then
                begin
                  BoInstanceOpenHealth := TRUE;
                  OpenHealthTime := 60 * 1000;
                  OpenHealthStart := GetTickCount;
                end;
              end;
            end;
          end;
          OpenStruck := True;
          if (Self = MySelf) and g_bo免助跑 then
             RunReadyCount := 0;

          if (Self = MySelf) and (not g_bo免助跑) then
            RunReadyCount := -2; //-1=2步，-2=3步...以此类推，逃生步数
//          if ((race = 0) or not g_boMirShowHp) then
//            BoInstanceOpenHealth := False;
//          if (race <> 34) then
//          begin
//            if not BoOpenStruckHealth then
//            begin
//              BoOpenStruckHealth := TRUE;
//              OpenStruckTime := 60 * 1000;
//              OpenStruckStart := GetTickCount;
//            end;
//          end;
        end;
      SM_SPELL:
        begin
          Dir := msg.dir;
               //msg.x  :targetx
               //msg.y  :targety
          pmag := PTUseMagicInfo(msg.feature);
          if pmag <> nil then
          begin
            CurMagic := pmag^;
            CurMagic.ServerMagicCode := -1; //FIRE 大气
                  //CurMagic.MagicSerial := 0;
            CurMagic.TargX := msg.x;
            CurMagic.TargY := msg.y;
            Dispose(pmag);
          end;
               //DScreen.AddSysMsg ('SM_SPELL');
        end;
    else
      begin
        XX := msg.x;
        YY := msg.y;
        Dir := msg.dir;
      end;
    end;

    CurrentAction := msg.Ident;
    CalcActorFrame;
      //DScreen.AddSysMsg (IntToStr(msg.Ident) + ' ' + IntToStr(XX) + ' ' + IntToStr(YY) + ' : ' + IntToStr(msg.x) + ' ' + IntToStr(msg.y));
  end
  else
  begin
    if msg.Ident = SM_SKELETON then
    begin
      CurrentAction := msg.Ident;
      CalcActorFrame;
      Skeleton := TRUE;
    end;
  end;
  if (msg.Ident = SM_DEATH) or (msg.Ident = SM_NOWDEATH) then
  begin
    if GroupIdList.Count > 0 then
      for i := 0 to GroupIdList.Count - 1 do
      begin  // MonOpenHp
        if integer(GroupIdList[i]) = RecogId then
        begin
          GroupIdList.Delete(i);
          Break;
        end;
      end;
    if MySelf = Self then
    begin
      THumActor(MySelf).m_StallMgr.OnSale := False;
      FillChar(THumActor(MySelf).m_StallMgr.mBlock, SizeOf(TClientStallInfo), 0);
      FrmMain.FillBagStallItem(0);
      FrmDlg.DWHeroStore.Visible := False;
    end;

    Death := TRUE;
    PlayScene.ActorDied(self);
  end;

  RunSound;
end;

procedure TActor.ProcMsg;
var
  msg: TChrMsg;
  meff: TMagicEff;
begin
  while TRUE do
  begin
    if MsgList.Count <= 0 then
      break;
    if CurrentAction <> 0 then
      break;
    msg := PTChrMsg(MsgList[0])^;
    Dispose(PTChrMsg(MsgList[0]));
    MsgList.Delete(0);

    case msg.ident of
      SM_STRUCK:
        begin
          HiterCode := msg.Sound; //打我的人
          ReadyAction(msg);
        end;
      SM_DEATH, SM_NOWDEATH, SM_SKELETON, SM_ALIVE,         // 2003/04/01 狂风斩施展样子
      SM_CROSSHIT, SM_TWINHIT, SM_STONEHIT, SM_ACTION_MIN..SM_ACTION_MAX, SM_ACTION2_MIN..SM_ACTION2_MAX, SM_DRAGON_LIGHTING..SM_LIGHTING_3, 3000..3099: //保留为客户端移动消息
        begin
          ReadyAction(msg);
        end;
      SM_SPACEMOVE_HIDE:
        begin
          meff := TScrollHideEffect.Create(250, 10, XX, YY, self);
          PlayScene.EffectList.Add(meff);
          PlaySound(s_spacemove_out);
        end;
      SM_SPACEMOVE_HIDE2:
        begin
          meff := TScrollHideEffect.Create(1590, 10, XX, YY, self);
          PlayScene.EffectList.Add(meff);
          PlaySound(s_spacemove_out);
        end;
      SM_SPACEMOVE_SHOW:
        begin
          meff := TCharEffect.Create(260, 10, self);
          PlayScene.EffectList.Add(meff);
          msg.ident := SM_TURN;
          ReadyAction(msg);
          PlaySound(s_spacemove_in);
        end;
      SM_SPACEMOVE_SHOW2:
        begin
          meff := TCharEffect.Create(1600, 10, self);
          PlayScene.EffectList.Add(meff);
          msg.ident := SM_TURN;
          ReadyAction(msg);
          PlaySound(s_spacemove_in);
        end;
            SM_SPACEMOVE_SHOW_MAGIC:
            begin
               msg.ident := SM_TURN;
               ReadyAction (msg);
               PlaySound (10566);
            end;
         SM_SPACEMOVE_SHOW_MAGIC2:
            begin
               msg.ident := SM_TURN;
               ReadyAction (msg);
            end;


    else
      begin
      end;
    end;
  end;

end;

procedure TActor.ProcHurryMsg; //处理需要快速处理的消息..
var
  n: integer;
  msg: TChrMsg;
  fin: Boolean;
begin
  n := 0;
  while TRUE do
  begin
    if MsgList.Count <= n then
      break;
    msg := PTChrMsg(MsgList[n])^;
    fin := FALSE;
    case msg.Ident of
      SM_MAGICFIRE:
        if CurMagic.ServerMagicCode <> 0 then
        begin
          CurMagic.ServerMagicCode := 111;
          CurMagic.Target := msg.x;
          if msg.y in [0..MAXMAGICTYPE - 1] then
            CurMagic.EffectType := TMagicType(msg.y);
          CurMagic.EffectNumber := msg.dir;
          CurMagic.TargX := msg.feature;
          CurMagic.TargY := msg.state;
          CurMagic.Recusion := TRUE;
          fin := TRUE;
         if CurMagic.EffectNumber = 54 then begin //Reincarnation
                  if CurMagic.Target > 0 then begin
                     if revivalmode = False then begin
                        revivalmode := True;
                        revivalmodetime := GetTickCount;
                     end else begin
                        revivalmode := False;
                     end;
                  end else begin
                     revivalmode := False;
                  end;
         end;
                        //DScreen.AddSysMsg ('SM_MAGICFIRE GOOD');
        end;
      SM_MAGICFIRE_FAIL:
        if CurMagic.ServerMagicCode <> 0 then
        begin
          CurMagic.ServerMagicCode := 0;
          fin := TRUE;
        end;
    end;
    if fin then
    begin
      Dispose(PTChrMsg(MsgList[n]));
      MsgList.Delete(n);
    end
    else
      Inc(n);
  end;
end;

function TActor.IsIdle: Boolean;
begin
  if (CurrentAction = 0) and (MsgList.Count = 0) then
    Result := TRUE
  else
    Result := FALSE;
end;

function TActor.ActionFinished: Boolean;
begin
  if (CurrentAction = 0) or (currentframe >= endframe) then
    Result := TRUE
  else
    Result := FALSE;
end;

function TActor.CanWalk: Integer;
begin
   //被击中后无法行走。 或魔法延迟
  if {(GetTickCount - LastStruckTime < 1300) or} (GetTickCount - LatestSpellTime < MagicPKDelayTime) then
    Result := -1   //延迟
  else
    Result := 1;
end;

function TActor.CanRun: Integer;
begin
   //如果您的敏捷性低或您的健康状况已耗尽，您将无法跑步。..
   //被击中后不能立即跑..
  Result := 1;
  if Abil.HP < RUN_MINHEALTH then
  begin
    Result := -1;
  end
  else if {(GetTickCount - LastStruckTime < RUN_STRUCK_DELAY) or } (GetTickCount - LatestSpellTime < MagicPKDelayTime) then  //前面屏蔽这段是设置被怪物攻击后不需要助跑，如果需要被怪物攻击助跑就取消这段的屏蔽
    Result := -2;

end;

function TActor.Strucked: Boolean;
var
  i: integer;
begin
  Result := FALSE;
  for i := 0 to MsgList.Count - 1 do
  begin
    if PTChrMsg(MsgList[i]).ident = SM_STRUCK then
    begin
      Result := TRUE;
      break;
    end;
  end;
end;

procedure TActor.Shift(dir, step, cur, max: integer);   //修复树荫颤动问题
var
  unx, uny, ss, v: Integer;
  funx, funy: Integer;
begin
  unx := UNITX * step;
  uny := UNITY * step;
  if cur > max then
    cur := max;
  Rx := XX;
  Ry := YY;
//   ss := Round((max-cur-1) / max) * step;
  case dir of
    DR_UP:
      begin
        ss := Round((max - cur) / max) * step;
        Ry := YY + ss;
        if ss = step then
        begin
          funx := -Round(uny / max * cur);
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftY := funx;
        end
        else
        begin
          funx := Round(uny / max * (max - cur));
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftY := funx;
        end;
      end;
    DR_UPRIGHT:
      begin
        if max >= 6 then
          v := 2
        else
          v := 0;
        ss := Round((max - cur + v) / max) * step;
        Rx := XX - ss;
        Ry := YY + ss;
        if ss = step then
        begin
          funx := Round(unx / max * cur);
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := -Round(uny / max * cur);
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end
        else
        begin
          funx := -Round(unx / max * (max - cur));
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := Round(uny / max * (max - cur));
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end;
      end;
    DR_RIGHT:
      begin
        ss := Round((max - cur) / max) * step;
        Rx := XX - ss;
        if ss = step then
        begin
          ShiftX := Round(unx / max * cur)
        end
        else
        begin
          ShiftX := -Round(unx / max * (max - cur));
        end;
        ShiftY := 0;
      end;
    DR_DOWNRIGHT:
      begin
        if max >= 6 then
          v := 2
        else
          v := 0;
        ss := Round((max - cur - v) / max) * step;
        Rx := XX - ss;
        Ry := YY - ss;
        if ss = step then
        begin
          funx := Round(unx / max * cur);
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;

          funy := Round(uny / max * cur);
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end
        else
        begin
          funx := -Round(unx / max * (max - cur));
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := -Round(uny / max * (max - cur));
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end;
      end;
    DR_DOWN:
      begin
        if max >= 6 then
          v := 1
        else
          v := 0;
        ss := Round((max - cur - v) / max) * step;
        ShiftX := 0;
        Ry := YY - ss;
        if ss = step then
        begin
          funy := Round(uny / max * cur);
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end
        else
        begin
          funy := -Round(uny / max * (max - cur));
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end;
      end;
    DR_DOWNLEFT:
      begin
        if max >= 6 then
          v := 2
        else
          v := 0;
        ss := Round((max - cur - v) / max) * step;
        Rx := XX + ss;
        Ry := YY - ss;
        if ss = step then
        begin
          funx := -Round(unx / max * cur);
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := Round(uny / max * cur);
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end
        else
        begin
          funx := Round(unx / max * (max - cur));
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := -Round(uny / max * (max - cur));
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end;
      end;
    DR_LEFT:
      begin
        ss := Round((max - cur) / max) * step;
        Rx := XX + ss;
        if ss = step then
        begin
          ShiftX := -Round(unx / max * cur)
        end
        else
        begin
          ShiftX := Round(unx / max * (max - cur));
        end;
        ShiftY := 0;
      end;
    DR_UPLEFT:
      begin
        if max >= 6 then
          v := 2
        else
          v := 0;
        ss := Round((max - cur + v) / max) * step;
        Rx := XX + ss;
        Ry := YY + ss;
        if ss = step then
        begin
          funx := -Round(unx / max * cur);
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := -Round(uny / max * cur);
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end
        else
        begin
          funx := Round(unx / max * (max - cur));
          if (funx mod 2) <> 0 then
            funx := funx + 1;
          ShiftX := funx;
          funy := Round(uny / max * (max - cur));
          if (funy mod 2) <> 0 then
            funy := funy + 1;
          ShiftY := funy;
        end;
      end;
  end;
end;
 //--------------------------------以上为修复树荫颤动问题

procedure TActor.FeatureChanged;
var
  haircount: integer;
begin
  case race of      //human
    0:
      begin
        hair := HAIRfeature(feature);         //变更
        dress := DRESSfeature(feature);
        weapon := WEAPONfeature(feature);
        Effect := Effectfeature (FeatureEx);  //翅膀增加
        BodyOffset := HUMANFRAME * Dress; //0男，1女
        haircount := WHairImg.ImageCount div HUMANFRAME div 2;
        if hair > haircount - 1 then
          hair := haircount - 1;
        hair := hair * 2;
        if hair > 1 then
          HairOffset := HUMANFRAME * (hair + Sex)
        else
          HairOffset := -1;
        WeaponOffset := HUMANFRAME * weapon; //(shape*2 + Sex);
        //翅膀增加
         if Effect <> 0 then begin
           if Effect = 50 then WingOffset := 352
          else WingOffset := (Effect - 1) * HUMANFRAME;
         end;
      { if dress = 18 then
          WingOffset := 0                  // 天衣无缝（男）
        else if dress = 19 then
          WingOffset := HUMANFRAME    // 天衣无缝(女)
        else if dress = 20 then
          WingOffset := HUMANFRAME * 2  // 天龙不死的（男）
        else if dress = 21 then
          WingOffset := HUMANFRAME * 3  // 天龙不死的（女）
        else if dress in [22, 23] then
          WingOffset := 352;    // 50等级衣服

        if weapon = 76 then
          WeaponEffectOffset := HUMANFRAME * 4        // 破冠真剑效果（男）
        else if weapon = 77 then
          WeaponEffectOffset := HUMANFRAME * 5;  // 破冠真剑效果（女） }
      end;
    50:
      ;  //npc
  else
    begin
      Appearance := APPRfeature(feature);
      BodyOffset := GetOffset(Appearance);
         //BodyOffset := MONFRAME * (Appearance mod 10);
    end;
  end;
end;

function TActor.Light: integer;
begin
  Result := ChrLight;
end;

procedure TActor.LoadSurface;
var
  mimg: TWMImages;
begin
  mimg := GetMonImg(Appearance);
  if mimg <> nil then
  begin
    if (not ReverseFrame) then
      BodySurface := mimg.GetCachedImage(GetOffset(Appearance) + currentframe, px, py)
    else
      BodySurface := mimg.GetCachedImage(GetOffset(Appearance) + endframe - (currentframe - startframe), px, py);
  end;
end;

function TActor.CharWidth: Integer;
begin
  if BodySurface <> nil then
    Result := BodySurface.Width
  else
    Result := 48;
end;

function TActor.CharHeight: Integer;
begin
  if BodySurface <> nil then
    Result := BodySurface.Height
  else
    Result := 70;
end;

function TActor.CheckSelect(dx, dy: integer): Boolean;
var
  c: integer;
begin
  Result := FALSE;
  if BodySurface <> nil then
  begin
    c := BodySurface.Pixels[dx, dy];
    if (c <> 0) and ((BodySurface.Pixels[dx - 1, dy] <> 0) and (BodySurface.Pixels[dx + 1, dy] <> 0) and (BodySurface.Pixels[dx, dy - 1] <> 0) and (BodySurface.Pixels[dx, dy + 1] <> 0)) then
      Result := TRUE;
  end;
end;

procedure TActor.DrawEffSurface(dsurface: TAsphyreCanvas; source: TAsphyreLockableTexture; ddx, ddy: integer; blend: Boolean; ceff: TColorEffect);
begin
  if state and $00800000 <> 0 then
  begin
    blend := TRUE;  //透明
  end;
  if not blend then
  begin
    if ceff = ceNone then
    begin
      if source <> nil then
        dsurface.Draw(ddx, ddy, source.ClientRect, source, TRUE);
    end
    else
    begin
      if source <> nil then
      begin
        dsurface.Draw(ddx, ddy, source.ClientRect, source, TRUE);
        DrawEffect(ddx, ddy, dsurface, source, ceff, blend);
      end;
    end;
  end
  else
  begin
    if ceff = ceNone then
    begin
      if source <> nil then
        if self = MySelf then
          dsurface.DrawAlpha(ddx, ddy, source, 90)  //隐身效果的透明度
        else
          dsurface.DrawAlpha(ddx, ddy, source, 150);
    end
    else
    begin
      if source <> nil then
      begin
        DrawEffect(ddx, ddy, dsurface, source, ceff, blend);
      end;
    end;
  end;
end;

procedure TActor.DrawWeaponGlimmer(dsurface: TAsphyreCanvas; ddx, ddy: integer);
var
  idx, ax, ay: integer;
  d: TAsphyreLockableTexture;
begin
   //禁用…（氯化物）图形错误…...
   (*if BoNextTimeFireHit and WarMode and GlimmingMode then begin
      if GetTickCount - GlimmerTime > 200 then begin
         GlimmerTime := GetTickCount;
         Inc (CurGlimmer);
         if CurGlimmer >= MaxGlimmer then CurGlimmer := 0;
      end;
      idx := GetEffectBase (5-1{氯化物闪烁}, 1) + Dir*10 + CurGlimmer;
      d := WMagic.GetCachedImage (idx, ax, ay);
      if d <> nil then
         DrawBlend (dsurface, ddx + ax, ddy + ay, d, 1);
                          //dx + ax + ShiftX,
                          //dy + ay + ShiftY,
                          //d, 1);
   end;*)
end;

function TActor.GetDrawEffectValue: TColorEffect;
var
  ceff: TColorEffect;
begin
  ceff := ceNone;

   //使选定的字符变亮。
  if (FocusCret = self) or (MagicTarget = self) then begin
 // begin
 //   if state <> 8388608 then
      ceff := ceBright;
  end;

   //人物中魔法外观效果
 // if state and $04000000 = 0 then
 // begin
    if state and $80000000 <> 0 then
    begin        //POISON_DECHEALTH    绿毒
      ceff := ceGreen;
    end;
    if state and $40000000 <> 0 then
    begin        //POISON_DAMAGEARMOR   红毒
      ceff := ceRed;
    end;

    if state and $20000000 <> 0 then
    begin        //POISON_ICE
      ceff := ceBlue;
    end;
    if state and $10000000 <> 0 then
    begin        //POISON_STUN
      ceff := ceYellow;
    end;
    if state and $08000000 <> 0 then
    begin        //POISON_SLOW
      ceff := ceFuchsia;
    end;
 // end;
  if state and $04000000 <> 0 then
  begin        //POISON_STONE   石化
    ceff := ceGrayScale;
  end;
  if state and $02000000 <> 0 then
  begin        //POISON_DONTMOVE
    ceff := ceGrayScale;
  end;

   // 2004/03/22 50 LevelEffect
  if (race = 0) and ((state and $00080000) <> 0) then //50LEVELEFFECT
    Bo50LevelEffect := True
  else
    Bo50LevelEffect := False;

{   FoodStickType := 0;
   if (Race = 0) and ((State and $00040000) <> 0) then //巧克力棒
      FoodStickType := 2;
   if (Race = 0) and ((State and $00020000) <> 0) then //龋冠
      FoodStickType := 1;
   if (Race = 0) and ((State and $00010000) <> 0) then //窍飘
      FoodStickType := 3;}
//   if (Race = 0) and (State and $00080000 <> 0) then //WRITEREFFECT
//      BoWriterEffect := True
//   else BoWriterEffect := False;

  Result := ceff;
end;

procedure TActor.DrawChr(dsurface: TAsphyreCanvas; dx, dy: integer; blend: Boolean; WingDraw: Boolean);
var
  idx, ax, ay: integer;
  d: TAsphyreLockableTexture;
  ceff: TColorEffect;
  wimg: TWMImages;
begin
  if not (dir in [0..7]) then
    exit;
  if GetTickCount - loadsurfacetime > (FREE_TEXTURE_TIME div 2) then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface; //防止内存被释放，因为 bodysurface 等不再调用 loadsurface
  end;

  ceff := GetDrawEffectValue;

  if BodySurface <> nil then
  begin
    DrawEffSurface(dsurface, BodySurface, dx + px + ShiftX, dy + py + ShiftY, blend, ceff);
  end;

  if BoUseMagic {and (EffDir[Dir] = 1)}  and (CurMagic.EffectNumber > 0) then
    if CurEffFrame in [0..SpellFrame - 1] then
    begin
      GetEffectBase(Curmagic.EffectNumber - 1, 0, wimg, idx);
      idx := idx + CurEffFrame;
      if wimg <> nil then
        d := wimg.GetCachedImage(idx, ax, ay);
      if d <> nil then
        dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);
    end;
end;

procedure TActor.DrawEff(dsurface: TAsphyreCanvas; dx, dy: integer);
begin
end;


function TActor.ChickAppearance: integer;
begin
  case Job of
    0..2:Result := 7;
    3,4:begin
      if weapon in [0..115] then Result := 7
      else Result := job;
    end;
    10..12:begin
       if Weapon in [2..11,12,13,162..171,216..219,224..227,230,231] then Result := job
       else Result := 255;
    end;
    13:begin
       if Weapon in [0..11,162..171,216..219,224..227,230,231] then Result := job
       else Result := 255;
    end;
    14:begin
       if Weapon in [2..19,20,21,42,43,192,193,204..211,222..223] then Result := job
       else Result := 255;
    end;
  end;
end;


function TActor.GetDefaultFrame(wmode: Boolean): integer;
var
  cf, dr: integer;
  pm: PTMonsterAction;
begin
  pm := RaceByPm(race, Appearance);
  if pm = nil then
    exit;

  if Death then
  begin
    if Skeleton then
      Result := pm.ActDeath.start
    else
      Result := pm.ActDie.start + dir * (pm.ActDie.frame + pm.ActDie.skip) + (pm.ActDie.frame - 1);
  end
  else
  begin
    defframecount := pm.ActStand.frame;
    if currentdefframe < 0 then
      cf := 0
    else if currentdefframe >= pm.ActStand.frame then
      cf := 0
    else
      cf := currentdefframe;
    Result := pm.ActStand.start + dir * (pm.ActStand.frame + pm.ActStand.skip) + cf;
  end;
end;

procedure TActor.DefaultMotion;   //无动作，默认姿势..
begin
  ReverseFrame := FALSE;
  if WarMode then
  begin
    if (GetTickCount - WarModeTime > WarModeCount * 1000) then //and not BoNextTimeFireHit then
    begin
      WarMode := FALSE;
      WarMode2 := False;
    end;
  end;
  currentframe := GetDefaultFrame(WarMode);
  Shift(dir, 0, 1, 1);
end;

//初始化声音变量.
procedure TActor.SetSound;
var
  cx, cy, bidx, wunit, attackweapon: integer;
  hiter: TActor;
begin
  if race = 0 then
  begin
    if (self = Myself) and ((CurrentAction = SM_WALK) or (CurrentAction = SM_BACKSTEP) or (CurrentAction = SM_RUN) or (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG)) then
    begin
      cx := Myself.XX - Map.BlockLeft;
      cy := Myself.YY - Map.BlockTop;
      cx := cx div 2 * 2;
      cy := cy div 2 * 2;
      bidx := Map.MArr[cx, cy].BkImg and $7FFF;
      wunit := Map.MArr[cx, cy].Area;
      bidx := wunit * 10000 + bidx - 1;
      case bidx of            //陋篮 钱
        330..349, 450..454, 550..554, 750..754, 950..954, 1250..1254, 1400..1424, 1455..1474, 1500..1524, 1550..1574:
          footstepsound := s_walk_lawn_l;

            //吝埃钱
            //变 钱
          250..254, 1005..1009, 1050..1054, 1060..1064, 1450..1454, 1650..1654:
          footstepsound := s_walk_rough_l;

            //倒 辨
            //措府籍 官蹿
          605..609, 650..654, 660..664, 2000..2049, 3025..3049, 2400..2424, 4625..4649, 4675..4678:
          footstepsound := s_walk_stone_l;

            //悼奔救
          1825..1924, 2150..2174, 3075..3099, 3325..3349, 3375..3399:
          footstepsound := s_walk_cave_l;

            //唱公官蹿
          3230, 3231, 3246, 3277:
          footstepsound := s_walk_wood_l;

           //带傈..
          3780..3799:
          footstepsound := s_walk_wood_l;

        3825..4434:
          if (bidx - 3825) mod 25 = 0 then
            footstepsound := s_walk_wood_l
          else
            footstepsound := s_walk_ground_l;


            //笼救(家府 喊风 救巢)
            2075..2099, 2125..2149:
          footstepsound := s_walk_room_l;

            //俺匡
          1800..1824:
          footstepsound := s_walk_water_l;

      else
        footstepsound := s_walk_ground_l;
      end;
         //泵傈郴何
      if (bidx >= 825) and (bidx <= 1349) then
      begin
        if ((bidx - 825) div 25) mod 2 = 0 then
          footstepsound := s_walk_stone_l;
      end;
         //悼奔郴何
      if (bidx >= 1375) and (bidx <= 1799) then
      begin
        if ((bidx - 1375) div 25) mod 2 = 0 then
          footstepsound := s_walk_cave_l;
      end;
      case bidx of
        1385, 1386, 1391, 1392:
          footstepsound := s_walk_wood_l;
      end;

      bidx := Map.MArr[cx, cy].MidImg and $7FFF;
      bidx := bidx - 1;
      case bidx of
        0..115:
          footstepsound := s_walk_ground_l;
        120..124:
          footstepsound := s_walk_lawn_l;
      end;

      bidx := Map.MArr[cx, cy].FrImg and $7FFF;
      bidx := bidx - 1;
      case bidx of            //寒倒辨
        221..289, 583..658, 1183..1206, 7163..7295, 7404..7414:
          footstepsound := s_walk_stone_l;
            //唱公付风
        3125..3267, {3319..3345, 3376..3433,} 3757..3948, 6030..6999:
          footstepsound := s_walk_wood_l;
            //规官蹿
        3316..3589:
          footstepsound := s_walk_room_l;
      end;
      if CurrentAction = SM_RUN then
        footstepsound := footstepsound + 2;

    end;

    if Sex = 0 then
    begin //巢磊
      screamsound := s_man_struck;
      diesound := s_man_die;
    end
    else
    begin //咯磊
      screamsound := s_wom_struck;
      diesound := s_wom_die;
    end;

    case CurrentAction of         // 2003/03/15 脚痹公傍
      SM_THROW, SM_HIT, SM_HIT + 1, SM_HIT + 2, SM_POWERHIT, SM_LONGHIT, SM_WIDEHIT, SM_FIREHIT, SM_CROSSHIT, SM_TWINHIT, SM_STONEHIT:
        begin
          case (weapon div 2) of
            6, 20:
              weaponsound := s_hit_short;
            1, 27, 28, 33:
              weaponsound := s_hit_wooden;
            2, 13, 9, 5, 14, 22, 25, 30, 35, 36, 37, 38:
              weaponsound := s_hit_sword;
            4, 17, 10, 15, 16, 23, 26, 29, 31, 34:
              weaponsound := s_hit_do;
            3, 7, 11:
              weaponsound := s_hit_axe;
            24:
              weaponsound := s_hit_club;
            8, 12, 18, 21, 32:
              weaponsound := s_hit_long;
          else
            weaponsound := s_hit_fist;
          end;
        end;
      SM_STRUCK:
        begin
          if MagicStruckSound >= 1 then
          begin  //被魔法击中
                  //strucksound := s_struck_magic;  //临时..
          end
          else
          begin
            hiter := PlayScene.FindActor(HiterCode);
            attackweapon := 0;
            if hiter <> nil then
            begin //检查打你的人用什么打的。
              attackweapon := hiter.weapon div 2;
              if hiter.Race = 0 then
                case (dress div 2) of
                  3: //盔甲
                    case attackweapon of
                      6:
                        strucksound := s_struck_armor_sword;
                      1, 2, 4, 5, 9, 10, 13, 14, 15, 16, 17, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38:
                        strucksound := s_struck_armor_sword;
                      3, 7, 11:
                        strucksound := s_struck_armor_axe;
                      8, 12, 18, 21, 32:
                        strucksound := s_struck_armor_longstick;
                    else
                      strucksound := s_struck_armor_fist;
                    end;
                else //一般
                  case attackweapon of
                    6:
                      strucksound := s_struck_body_sword;
                    1, 2, 4, 5, 9, 10, 13, 14, 15, 16, 17, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38:
                      strucksound := s_struck_body_sword;
                    3, 7, 11:
                      strucksound := s_struck_body_axe;
                    8, 12, 18, 21, 32:
                      strucksound := s_struck_body_longstick;
                  else
                    strucksound := s_struck_body_fist;
                  end;
                end;
            end;
          end;
        end;
    end;

      //魔法声
    if BoUseMagic and (CurMagic.MagicSerial > 0) then
    begin
      magicstartsound := 10000 + CurMagic.MagicSerial * 10;
      magicfiresound := 10000 + CurMagic.MagicSerial * 10 + 1;
      magicexplosionsound := 10000 + CurMagic.MagicSerial * 10 + 2;
    end;

  end
  else
  begin
    if CurrentAction = SM_STRUCK then
    begin
      if MagicStruckSound >= 1 then
      begin  //被魔法击中
            //strucksound := s_struck_magic;  //烙矫..
      end
      else
      begin
        hiter := PlayScene.FindActor(HiterCode);
        if hiter <> nil then
        begin  //检查打你的人用什么打的。
          attackweapon := hiter.weapon div 2;
          case attackweapon of
            6:
              strucksound := s_struck_body_sword;
            1, 2, 4, 5, 9, 10, 13, 14, 15, 16, 17, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38:
              strucksound := s_struck_body_sword;
            3, 7, 11:
              strucksound := s_struck_body_axe;
            8, 12, 18, 21, 32:
              strucksound := s_struck_body_longstick;
          else
            strucksound := s_struck_body_fist;
          end;
        end;
      end;
    end;

    if race = 50 then
    begin
    end
    else
    begin
//      if Race = 91 then   // 汲牢措面 Appearance=> 220
//         DScreen.AddChatBoardString ('[Race = 91]Appearance=> '+IntToStr(Appearance), clYellow, clRed);
      appearsound := 200 + (Appearance) * 10;
      normalsound := 200 + (Appearance) * 10 + 1;
      attacksound := 200 + (Appearance) * 10 + 2;  //哇哇
      weaponsound := 200 + (Appearance) * 10 + 3;  //呼（武器挥舞）
      screamsound := 200 + (Appearance) * 10 + 4;
      diesound := 200 + (Appearance) * 10 + 5;
      die2sound := 200 + (Appearance) * 10 + 6;
    end;
  end;

   //挨刀子的声音
  if CurrentAction = SM_STRUCK then
  begin
    hiter := PlayScene.FindActor(HiterCode);
    attackweapon := 0;
    if hiter <> nil then
    begin  //检查打你的人用什么打的。
      attackweapon := hiter.weapon div 2;
      if hiter.Race = 0 then
        case (attackweapon div 2) of
          6, 20:
            struckweaponsound := s_struck_short;
          1, 27, 28, 33:
            struckweaponsound := s_struck_wooden;
          2, 13, 9, 5, 14, 22, 25, 30, 35, 36, 37, 38:
            struckweaponsound := s_struck_sword;
          4, 17, 10, 15, 16, 23, 26, 29, 31, 34:
            struckweaponsound := s_struck_do;
          3, 7, 11:
            struckweaponsound := s_struck_axe;
          24:
            struckweaponsound := s_struck_club;
          8, 12, 18, 21, 32:
            struckweaponsound := s_struck_wooden; //long;
               //else struckweaponsound := s_struck_fist;
        end;
    end;
  end;
end;

procedure TActor.RunSound;
begin
  borunsound := TRUE;
  SetSound;
  case CurrentAction of
    SM_STRUCK:
      begin
        if (struckweaponsound >= 0) then
          PlaySound(struckweaponsound);
        if (strucksound >= 0) then
          PlaySound(strucksound);
        if (screamsound >= 0) then
          PlaySound(screamsound);
      end;
    SM_NOWDEATH:
      begin
        if (diesound >= 0) then
          PlaySound(diesound);

        if (Self = MySelf) and MySelf.Death then
        begin //死亡背景音乐
          TargetCret := nil;
          PlayBGM(bmp_die);
           if not g_Deatheject then Exit;
          if mrOk = FrmDlg.DSimpleMessageDlg('你已经死亡, 你需要在最后停留的城镇\回城点复活吗? ', [mbOk, mbCancel]) then
          begin
            FrmMain.SendSay('@ReAliveHome');
          end;
        end;
      end;
    SM_THROW, SM_HIT, SM_FLYAXE, SM_LIGHTING, SM_DIGDOWN{门关上了}:
      begin
        if ((race = 91) and (CurrentAction = SM_LIGHTING)) then
          PlaySound(2406) // 雪人粗略的Attact2声音
        else if ((race = 92) and (CurrentAction = SM_LIGHTING)) then
          PlaySound(2416) // 跑马雷场附件2声音
        else if ((race = 93) and (CurrentAction = SM_LIGHTING)) then
          PlaySound(2426) // 欢迎的// Attact2声音
        else if ((race = 94) and (CurrentAction = SM_LIGHTING)) then
          PlaySound(2436) // 芭固 Attact2 荤款靛
        else if attacksound >= 0 then
          PlaySound(attacksound);
      end;
//      SM_ALIVE, SM_DIGUP{登场，开门}:
    SM_ALIVE, //
    SM_DIGUP{登场，开门}: //####
      begin
        PlaySound(appearsound);
      end;
    SM_SPELL:
      begin
        PlaySound(magicstartsound);
      end;
  end;
end;

procedure TActor.RunActSound(frame: integer);
begin
  if borunsound then
  begin
    if race = 0 then
    begin
      case CurrentAction of
        SM_THROW, SM_HIT, SM_HIT + 1, SM_HIT + 2:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            borunsound := FALSE;
          end;

        SM_POWERHIT:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            if Sex = 0 then
              PlaySound(s_yedo_man)
            else
              PlaySound(s_yedo_woman);
            borunsound := FALSE;
          end;
        SM_LONGHIT:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            PlaySound(s_longhit);
            borunsound := FALSE; //只发出一次声音
          end;
        SM_WIDEHIT:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            PlaySound(s_widehit);
            borunsound := FALSE;
          end;
        SM_FIREHIT:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            PlaySound(s_firehit);
            borunsound := FALSE;
          end;
        SM_CROSSHIT:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            PlaySound(s_crosshit);
            borunsound := FALSE; //只发出一次声音
          end;
        SM_TWINHIT:
          if frame = 2 then
          begin
            PlaySound(weaponsound);
            PlaySound(s_twinhit);
            borunsound := FALSE;
          end;
      end;
    end
    else
    begin
      if race = 50 then
      begin
      end
      else
      begin
          //(** 货 荤款靛
        if (CurrentAction = SM_WALK) or (CurrentAction = SM_TURN) then
        begin
          if (frame = 1) and (Random(8) = 1) then
          begin
            PlaySound(normalsound);
            borunsound := FALSE; //只发出一次声音
          end;
        end;
        if CurrentAction = SM_HIT then
        begin
          if (frame = 3) and (attacksound >= 0) then
          begin
            PlaySound(weaponsound);
            borunsound := FALSE;
          end;
        end;
        case Appearance of
          80: //包冠零
            begin
              if CurrentAction = SM_NOWDEATH then
              begin
                if (frame = 2) then
                begin
                  PlaySound(die2sound);
                  borunsound := FALSE; //只发出一次声音
                end;
              end;
            end;
        end;
      end; //*)

    end;
  end;
end;

procedure TActor.RunFrameAction(frame: integer);
begin
end;

procedure TActor.ActionEnded;
begin
end;

procedure TActor.Run;

  function MagicTimeOut: Boolean;
  begin
//      if self = Myself then begin
    Result := GetTickCount - WaitMagicRequest > 3000;
//      end else
//         Result := GetTickCount - WaitMagicRequest > 2000;
    if Result then
      CurMagic.ServerMagicCode := 0;
  end;

var
  prv: integer;
  frametimetime: longword;
  bofly: Boolean;
begin

  if (CurrentAction = SM_WALK) or (CurrentAction = SM_BACKSTEP) or (CurrentAction = SM_RUN) or (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG) then
    exit;

  msgmuch := FALSE;
  if self <> Myself then
  begin
    if MsgList.Count >= 2 then
      msgmuch := TRUE;
  end;

   //声音效果
  RunActSound(currentframe - startframe);
  RunFrameAction(currentframe - startframe);

  prv := currentframe;
  if CurrentAction <> 0 then
  begin
    if (currentframe < startframe) or (currentframe > endframe) then
      currentframe := startframe;

//      if (self <> Myself) and (BoUseMagic) then begin
//         frametimetime := Round(frametime / 1.8);
//      end else begin
    if msgmuch then
      frametimetime := Round(frametime * 2 / 3)
    else
      frametimetime := frametime; //2004/04/07 加档包访 荐沥
//      end;

    if GetTickCount - starttime > frametimetime then
    begin
      if currentframe < endframe then
      begin
            //如果是魔法，请接收服务器的信号，确认成功/失败。
            //结束最后一个动作.
        if BoUseMagic then
        begin
          if (CurEffFrame = SpellFrame - 2) or (MagicTimeOut) then
          begin //等待结束
            if (CurMagic.ServerMagicCode >= 0) or (MagicTimeOut) then
            begin //从服务器收到的结果。还没来就等著。
              Inc(currentframe);
              Inc(CurEffFrame);
              starttime := GetTickCount;
            end;
          end
          else
          begin
            if currentframe < endframe - 1 then
              Inc(currentframe);
            Inc(CurEffFrame);
            starttime := GetTickCount;
          end;
        end
        else
        begin
          Inc(currentframe);
          starttime := GetTickCount;
        end;

      end
      else
      begin
        if BoDelActionAfterFinished then
        begin
               //此动作后消失。
          BoDelActor := TRUE;
        end;
            //行动结束。
        if self = Myself then
        begin
               //如果你是主角
          if FrmMain.ServerAcceptNextAction then
          begin
            ActionEnded;
            CurrentAction := 0;
            BoUseMagic := FALSE;
          end;
        end
        else
        begin
          ActionEnded;
          CurrentAction := 0; //动作完成
          BoUseMagic := FALSE;
        end;
      end;
      if BoUseMagic then
      begin
            //使用魔法时
        if CurEffFrame = SpellFrame - 1 then
        begin //魔法发射时间
               //魔法发射
          if CurMagic.ServerMagicCode > 0 then
          begin
            with CurMagic do
              PlayScene.NewMagic(self, ServerMagicCode, EffectNumber, XX, YY, TargX, TargY, Target, EffectType, Recusion, AniTime, bofly);
            if bofly then
              PlaySound(magicfiresound)
            else
              PlaySound(magicexplosionsound);
          end;
               //LatestSpellTime := GetTickCount;
          CurMagic.ServerMagicCode := 0;
        end;
      end;
    end;
    if Appearance in [0, 1, 43] then
      currentdefframe := -10
    else
      currentdefframe := 0;
    defframetime := GetTickCount;
  end
  else
  begin
    if GetTickCount - smoothmovetime > 200 then
    begin
      if GetTickCount - defframetime > 500 then
      begin
        defframetime := GetTickCount;
        Inc(currentdefframe);
        if currentdefframe >= defframecount then
          currentdefframe := 0;
      end;
      DefaultMotion;
    end;
  end;

  if (prv <> currentframe) then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface;
  end;
end;

function TActor.Move(step: integer): Boolean;
var
  prv, curstep, maxstep: integer;
  fastmove, normmove: Boolean;
begin
  Result := FALSE;
  fastmove := FALSE;
  normmove := FALSE;
  if (CurrentAction = SM_BACKSTEP) then //or (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG) then
    fastmove := TRUE;
  if (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG) then
    normmove := TRUE;
   // 2003/07/03 活动用的代码
//   if ((UseItems[U_DRESS].S.Shape = 10) or
//       (UseItems[U_DRESS].S.Shape = 12) )and (UseItems[U_DRESS].Dura > 0) then begin
//      fastmove := TRUE;
//   end;

  if (self = Myself) and (not fastmove) and (not normmove) then
  begin
    BoMoveSlow := FALSE;
    BoMoveSlow2 := FALSE;
    BoAttackSlow := FALSE;
    MoveSlowLevel := 0;
    MoveSlowValue := 0;
      //屏蔽超重后减速，
    if g_WeightSet = 0 then
    begin
      if Abil.Weight > Abil.MaxWeight then
      begin
        MoveSlowLevel := Abil.Weight div Abil.MaxWeight;
        BoMoveSlow := TRUE;
      end;
      if Abil.WearWeight > Abil.MaxWearWeight then
      begin
        MoveSlowLevel := MoveSlowLevel + Abil.WearWeight div Abil.MaxWearWeight;
        BoMoveSlow := TRUE;
      end;
      if Abil.HandWeight > Abil.MaxHandWeight then
      begin
        BoAttackSlow := TRUE;
      end;
    end;
      // 2003/07/15 额外减慢状态异常...减慢移动速度和攻击速度
    if state and $08000000 <> 0 then
    begin        //POISON_SLOW
      MoveSlowLevel := MoveSlowLevel + 5;
      MoveSlowValue := 1; //诅咒术慢速度调整
      BoMoveSlow2 := TRUE;
      BoAttackSlow := TRUE;
    end;
         //屏蔽超重后减速，
    if BoMoveSlow and (SkipTick < MoveSlowLevel) then
    begin
      Inc(SkipTick); //休息一次促.
      exit;
    end
    else
    begin
      SkipTick := 0;
    end;

    if BoMoveSlow2 and (SkipTick2 > MoveSlowValue) then
    begin
      SkipTick2 := 0;
      exit;
    end
    else
    begin
      Inc(SkipTick2);
    end;

      //声音效果
    if (CurrentAction = SM_WALK) or (CurrentAction = SM_BACKSTEP) or (CurrentAction = SM_RUN) or (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG) then
    begin
      case (currentframe - startframe) of
        1:
          PlaySound(footstepsound);
        4:
          PlaySound(footstepsound + 1);
      end;
    end;
  end;

  Result := FALSE;
  msgmuch := FALSE;
  if self <> Myself then
  begin
    if MsgList.Count >= 2 then
      msgmuch := TRUE;
  end;
  prv := currentframe;
   //步行跑
  if (CurrentAction = SM_WALK) or (CurrentAction = SM_RUN) or (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG) then
  begin
    if (currentframe < startframe) or (currentframe > endframe) then
    begin
      currentframe := startframe - 1;
    end;
    if currentframe < endframe then
    begin
      Inc(currentframe);
      if msgmuch and not normmove then //or fastmove then
        if currentframe < endframe then
          Inc(currentframe);

         //为了让它平稳移动
      curstep := currentframe - startframe + 1;
      maxstep := endframe - startframe + 1;
      Shift(dir, movestep, curstep, maxstep);
    end;
    if currentframe >= endframe then
    begin
      if self = Myself then
      begin
        if FrmMain.ServerAcceptNextAction then
        begin
          CurrentAction := 0;     //当收到来自服务器的信号时，下一个动作
          LockEndFrame := TRUE;   //在最后一帧停止，因为没有来自服务器的信号
          smoothmovetime := GetTickCount;
        end;
      end
      else
      begin
        CurrentAction := 0; //动作完成
        LockEndFrame := TRUE;
        smoothmovetime := GetTickCount;
      end;
      Result := TRUE;
    end;
    if CurrentAction = SM_RUSH then
    begin
      if self = Myself then
      begin
        DizzyDelayStart := GetTickCount;
        DizzyDelayTime := 300; //延迟
      end;
    end;
    if CurrentAction = SM_RUSHKUNG then
    begin
      if currentframe >= endframe - 3 then
      begin
        XX := actbeforex;
        YY := actbeforey;
        Rx := XX;
        Ry := YY;
        CurrentAction := 0;
        LockEndFrame := TRUE;
            //smoothmovetime := GetTickCount;
      end;
    end;
    Result := TRUE;
  end;
   //退步
  if (CurrentAction = SM_BACKSTEP) then
  begin
    if (currentframe > endframe) or (currentframe < startframe) then
    begin
      currentframe := endframe + 1;
    end;
    if currentframe > startframe then
    begin
      Dec(currentframe);
      if msgmuch or fastmove then
        if currentframe > startframe then
          Dec(currentframe);

         //为了让它平稳移动
      curstep := endframe - currentframe + 1;
      maxstep := endframe - startframe + 1;
      Shift(GetBack(dir), movestep, curstep, maxstep);
    end;
    if currentframe <= startframe then
    begin
      if self = Myself then
      begin
            //if FrmMain.ServerAcceptNextAction then begin
        CurrentAction := 0;     //当收到来自服务器的信号时，下一个动作
        LockEndFrame := TRUE;   //在最后一帧停止，因为没有来自服务器的信号
        smoothmovetime := GetTickCount;

               //被推回去之后，我一时间动弹不得。        不知道这里是不是：被野蛮抗拒后人物停顿的时间？
        DizzyDelayStart := GetTickCount;
        DizzyDelayTime := 1000; //1秒延迟
            //end;
      end
      else
      begin
        CurrentAction := 0; //动作完成
        LockEndFrame := TRUE;
        smoothmovetime := GetTickCount;
      end;
      Result := TRUE;
    end;
    Result := TRUE;
  end;
  if prv <> currentframe then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface;
  end;
end;

procedure TActor.MoveFail;
begin
  CurrentAction := 0; //动作完成
  LockEndFrame := TRUE;
  Myself.XX := oldx;
  Myself.YY := oldy;
  Myself.Dir := olddir;
  CleanUserMsgs;
end;

function TActor.CanCancelAction: Boolean;
begin
  Result := FALSE;
  if CurrentAction = SM_HIT then
    if not BoUseEffect then
      Result := TRUE;
end;

procedure TActor.CancelAction;
begin
  CurrentAction := 0; //动作完成
  LockEndFrame := TRUE;
end;

procedure TActor.CleanCharMapSetting(x, y: integer);
begin
  Myself.XX := x;
  Myself.YY := y;
  Myself.RX := x;
  Myself.RY := y;
  oldx := x;
  oldy := y;
  CurrentAction := 0;
  currentframe := -1;
  CleanUserMsgs;
end;

procedure TActor.Say(str: string);
var
  i, len, aline, n: integer;
  dline, temp: string;
  loop: Boolean;
const
  MAXWIDTH = 150;
begin
  SayTime := GetTickCount;
  SayLineCount := 0;

  n := 0;
  loop := TRUE;
  while loop do
  begin
    temp := '';
    i := 1;
    len := Length(str);
    while TRUE do
    begin
      if i > len then
      begin
        loop := FALSE;
        break;
      end;
      if byte(str[i]) >= 128 then
      begin
        temp := temp + str[i];
        Inc(i);
        if i <= len then
          temp := temp + str[i]
        else
        begin
          loop := FALSE;
          break;
        end;
      end
      else
        temp := temp + str[i];

      aline := FrmMain.Canvas.TextWidth(temp);
      if aline > MAXWIDTH then
      begin
        Saying[n] := temp;
        SayWidths[n] := aline;
        Inc(SayLineCount);
        Inc(n);
        if n >= MAXSAY then
        begin
          loop := FALSE;
          break;
        end;
        str := Copy(str, i + 1, len - i);
        temp := '';
        break;
      end;
      Inc(i);
    end;
    if temp <> '' then
    begin
      if n < MAXWIDTH then
      begin
        Saying[n] := temp;
        SayWidths[n] := FrmMain.Canvas.TextWidth(temp);
        Inc(SayLineCount);
      end;
    end;
  end;
end;



{============================== NPCActor =============================}


// 2003/07/15 脚痹 NPC 眠啊
constructor TNpcActor.Create;
begin
  inherited Create;
  EffectSurface := nil;
  BoUseEffect := FALSE;
  PlaySnow := False;
  PalySu := False;
end;

procedure TNpcActor.CalcActorFrame;
var
  pm: PTMonsterAction;
  haircount: integer;
begin
  BoUseMagic := FALSE;
  currentframe := -1;

  BodyOffset := GetNpcOffset(Appearance);

  pm := RaceByPm(race, Appearance);
  if pm = nil then
    exit;
  dir := dir mod 3;  //方向只有0、1和2..
  case CurrentAction of
    SM_TURN: //NewNpc
      begin
        if Appearance = 57 then
        begin
          dir := 0;
          pm.ActStand.frame := 10;
          pm.ActStand.ftime := 120;
        end
        else if Appearance in [27, 29..33, 45, 58, 60, 69..74, 78..80,83,84,171..180] then
          dir := 0;

        startframe := pm.ActStand.start + dir * (pm.ActStand.frame + pm.ActStand.skip);
        endframe := startframe + pm.ActStand.frame - 1;
        frametime := pm.ActStand.ftime;
        starttime := GetTickCount;
        defframecount := pm.ActStand.frame;
        Shift(dir, 0, 0, 1);

        {if ((Appearance = 33) or (Appearance = 34)) and (not BoUseEffect) then
        begin
          BoUseEffect := TRUE;
          effectstart := 30;
          effectframe := effectstart;
          effectend := effectstart + 9;
          effectstarttime := GetTickCount;
          effectframetime := 300;
        end
        else}         if Appearance in [{42}46..47] then
        begin //FireDragon
          startframe := 20;
          endframe := 10;
          BoUseEffect := TRUE;
          effectstart := 0;
          effectframe := 0;
          effectend := 19;
          effectstarttime := GetTickCount;
          effectframetime := 100;
        end
        else if Appearance = 51 then
        begin //2004/05/27 50LevelQuest 刮痹
          BoUseEffect := TRUE;
          effectstart := 60;
          effectframe := effectstart;
          effectend := effectstart + 7;
          effectstarttime := GetTickCount;
          effectframetime := 500;
        end
        else if Appearance in [61..64] then
        begin //非月神殿
          startframe := 6;
          endframe := 7;
          BoUseEffect := TRUE;
          effectstart := 0;
          effectframe := 0;
          effectend := 4;
          effectstarttime := GetTickCount;
          effectframetime := 100;
        end
        else if Appearance = 65 then
        begin //篝火
          startframe := 8;
          endframe := 9;
          BoUseEffect := TRUE;
          effectstart := 0;
          effectframe := 0;
          effectend := 5;
          effectstarttime := GetTickCount;
          effectframetime := 100;
        end
        else if Appearance = 66 then
        begin
          startframe := 0;
          endframe := 19;
          frametime := 200;
          starttime := GetTickCount;
          defframecount := 19;
          BoUseEffect := TRUE;
          effectstart := 20;
          effectframe := effectstart;
          effectend := effectstart + 19;
          effectstarttime := GetTickCount;
          effectframetime := 200;
        end
        else if Appearance = 266 then
        begin
          startframe := 0;
          endframe := 19;
          frametime := 200;
          starttime := GetTickCount;
          defframecount := 19;
          BoUseEffect := TRUE;
          effectstart := 20;
          effectframe := effectstart;
          effectend := effectstart + 29;
          effectstarttime := GetTickCount;
          effectframetime := 200;
        end
      end;
    SM_HIT:
      begin
            // 2003/07/15 脚痹 NPC 眠啊
        if Appearance = 57 then
        begin
          dir := 0;
          pm.ActStand.frame := 10;
          pm.ActStand.ftime := 120;
        end
        else if Appearance in [58, 60, 69..74, 78..80,83,84,171..180] then
          dir := 0;

        if Appearance in [26..45, 52, 55..60, 68..77,83,84,171..180] then
        begin //无动作，只有站立动作
//            if Appearance = 55 then DScreen.AddChatBoardString ('Appearance = 55', clYellow, clRed);
          startframe := pm.ActStand.start + dir * (pm.ActStand.frame + pm.ActStand.skip);
          endframe := startframe + pm.ActStand.frame - 1;
          frametime := pm.ActStand.ftime;
          starttime := GetTickCount;
          defframecount := pm.ActStand.frame;
        end
        else
        begin
          startframe := pm.ActAttack.start + dir * (pm.ActAttack.frame + pm.ActAttack.skip);
          endframe := startframe + pm.ActAttack.frame - 1;
          if Appearance = 67 then
            endframe := startframe + 5;
          frametime := pm.ActAttack.ftime;
          starttime := GetTickCount;
          if Appearance = 51 then
          begin //2004/05/27 50LevelQuest 刮痹
            BoUseEffect := TRUE;
            effectstart := 60;
            effectframe := effectstart;
            effectend := effectstart + 7;
            effectstarttime := GetTickCount;
            effectframetime := 500;
          end
        end;
        if Appearance in [61..64] then
        begin //飞越神殿火花
          startframe := 6;
          endframe := 7;
          BoUseEffect := TRUE;
          effectstart := 0;
          effectframe := 0;
          effectend := 4;
          effectstarttime := GetTickCount;
          effectframetime := 100;
        end
        else if Appearance = 65 then
        begin //篝火
          startframe := 8;
          endframe := 9;
          BoUseEffect := TRUE;
          effectstart := 0;
          effectframe := 0;
          effectend := 5;
          effectstarttime := GetTickCount;
          effectframetime := 100;
        end
        else if Appearance = 66 then
        begin //圣诞树
          startframe := 0;
          endframe := 19;
          frametime := 200;
          starttime := GetTickCount;
          defframecount := 19;
          BoUseEffect := TRUE;
          effectstart := 20;
          effectframe := effectstart;
          effectend := effectstart + 19;
          effectstarttime := GetTickCount;
          effectframetime := 200;
        end
        else if Appearance = 266 then
        begin //圣诞树
          startframe := 0;
          endframe := 19;
          frametime := 200;
          starttime := GetTickCount;
          defframecount := 19;
          BoUseEffect := TRUE;
          effectstart := 20;
          effectframe := effectstart;
          effectend := effectstart + 29;
          effectstarttime := GetTickCount;
          effectframetime := 200;
        end;
      end;
    SM_DIGUP:
      begin
        if Appearance = 52 then
        begin //2004/12/14 雪人
          PlaySnow := True;
          SnowStartTime := GetTickCount + 23000;
          Randomize;
          SilenceSound;
          PlaySound(146 + Random(7));
          BoUseEffect := TRUE;
          effectstart := 60;
          effectframe := effectstart;
          effectend := effectstart + 11;
          effectstarttime := GetTickCount;
          effectframetime := 100;
        end;
      end;
  end;
  if Appearance in [27, 29..33, 45, 48..50, 52..55, 57..65, 69..74, 78..80] then
    dir := 0; //韩方固定 NewNpc
end;

function TNpcActor.GetDefaultFrame(wmode: Boolean): integer;
var
  cf, dr: integer;
  pm: PTMonsterAction;
begin
  pm := RaceByPm(race, Appearance);
  if pm = nil then
    exit;
  dir := dir mod 3;  //方向只有0、1和2..

  if Appearance in [{35..41,} 48..50, 52..55, 57..65, 69..74, 78..80] then
    dir := 0; //韩方固定 NewNpc

  if currentdefframe < 0 then
    cf := 0
  else if currentdefframe >= pm.ActStand.frame then
    cf := 0
  else
    cf := currentdefframe;
  Result := pm.ActStand.start + dir * (pm.ActStand.frame + pm.ActStand.skip) + cf;

  if Appearance in [61..64] then
  begin //飞越神殿火花
    Result := 6;
    BoUseEffect := TRUE;
  end
  else if Appearance = 65 then
  begin //篝火
    Result := 8;
    BoUseEffect := TRUE;
  end
  else if Appearance = 66 then
  begin  //圣诞树
    Result := cf;
    BoUseEffect := TRUE;
  end
    else if Appearance = 266 then
  begin  //圣诞树
    Result := cf;
    BoUseEffect := TRUE;
  end;
end;

procedure TNpcActor.LoadSurface;
begin
  case race of      //商人 Npc
    50:
      BodySurface := WNpcImg.GetCachedImage(BodyOffset + currentframe, px, py);
  end;

  if Appearance in [{42}46..47, 61..65] then
  begin // BodySurface 无需仅需要此效果 (啪篮 Object)
    BodySurface := nil;
  end;

  if BoUseEffect then
  begin // 矫傍籍,拳吩阂,啪阂,蓖脚npc
    {if Appearance in [33, 34] then
    begin // 拳搁俊 唱鸥唱绰 困摹 焊沥
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
    end
    else if Appearance = 42 then
    begin// 阂亲酒府(快) Object客 困摹甫 阿磊 嘎苗具窃.  FireDragon
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 71;
      ay := ay + 5;
    end
    else if Appearance = 43 then
    begin// 阂亲酒府(谅)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 71;
      ay := ay + 37;
    end
    else if Appearance = 44 then
    begin// 啪阂(快窍)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 7;
      ay := ay - 12;
    end
    else if Appearance = 45 then
    begin// 啪阂(快惑)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 6;
      ay := ay - 12;
    end
    else }
    if Appearance = 46 then
    begin// 啪阂(谅窍)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 7;
      ay := ay - 12;
    end
    else if Appearance = 47 then
    begin// 啪阂(谅惑)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 8;
      ay := ay - 12;
    end
    else if Appearance = 51 then
    begin// 蓖脚 npc
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
    end
    else if Appearance = 52 then
    begin// 传荤恩
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
    end
    else if Appearance = 61 then
    begin// 厚岿脚傈 阂采(谅惑)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 25;
      ay := ay - 8;
    end
    else if Appearance = 62 then
    begin// 厚岿脚傈 阂采(快惑)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax + 7;
      ay := ay - 7;
    end
    else if Appearance = 63 then
    begin// 厚岿脚傈 阂采(谅窍)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax - 4;
      ay := ay + 8;
    end
    else if Appearance = 64 then
    begin// 厚岿脚傈 阂采(快窍)
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
      ax := ax - 11;
      ay := ay + 8;
    end
    else if Appearance = 65 then
    begin// 葛蹿阂
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
    end
    else if Appearance = 66 then
    begin// 农府胶付胶飘府
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
    end
        else if Appearance = 266 then
    begin// 农府胶付胶飘府
      EffectSurface := WNpcImg.GetCachedImage(BodyOffset + effectframe, ax, ay);
    end;
  end;
end;

procedure TNpcActor.Run;
var
  prv: integer;
  effectframetimetime: longword;
begin
  inherited Run;
  if not PalySu then
  begin
    case Appearance of    //怪物NPC声音特效
      26:
        PlaySound('wav\' + '470-1' + '.wav');
      27:
        PlaySound('wav\' + '300-1' + '.wav');
      28:
        PlaySound('wav\' + '1200-1' + '.wav');
      29:
        PlaySound('wav\' + '400-1' + '.wav');
      30:
        PlaySound('wav\' + '410-1' + '.wav');
      31:
        PlaySound('wav\' + '420-1' + '.wav');
      32:
        PlaySound('wav\' + '430-1' + '.wav');
      33:
        PlaySound('wav\' + '1700-1' + '.wav');
      34:
        PlaySound('wav\' + '700-1' + '.wav');
      35:
        PlaySound('wav\' + '1300-1' + '.wav');
      36:
        PlaySound('wav\' + '500-1' + '.wav');
      37:
        PlaySound('wav\' + '520-1' + '.wav');
      38:
        PlaySound('wav\' + '530-1' + '.wav');
      39:
        PlaySound('wav\' + '510-1' + '.wav');
      40:
        PlaySound('wav\' + '1710-1' + '.wav');
      41:
        PlaySound('wav\' + '540-1' + '.wav');
    end;
    PalySu := True;
  end;

   // 2003/07/15 脚痹 NPC 眠啊
  prv := effectframe;
  if BoUseEffect then
  begin
    if msgmuch then
      effectframetimetime := Round(effectframetime * 2 / 3)
    else
      effectframetimetime := effectframetime;
    if GetTickCount - effectstarttime > effectframetimetime then
    begin
      effectstarttime := GetTickCount;
      if effectframe < effectend then
      begin
        Inc(effectframe);
      end
      else
      begin
        if PlaySnow then
        begin
          if SnowStartTime < GetTickCount then
          begin
            BoUseEffect := False;
            PlaySnow := False;
            SnowStartTime := GetTickCount;
          end;
          effectframe := effectstart;
        end
        else
          effectframe := effectstart;
        effectstarttime := GetTickCount;
      end;
    end;
  end;
  if (prv <> effectframe) then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface;
  end;
end;

// 2003/07/15 脚痹 NPC 眠啊
procedure TNpcActor.DrawChr(dsurface: TAsphyreCanvas; dx, dy: integer; blend: Boolean; WingDraw: Boolean);
var
  idx, ax, ay: integer;
  d: TAsphyreLockableTexture;
  ceff: TColorEffect;
  wimg: TWMImages;
begin
  dir := dir mod 3;  //规氢篮 0, 1, 2 观俊 绝澜..
  if GetTickCount - loadsurfacetime > (FREE_TEXTURE_TIME div 2) then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface;
  end;

  ceff := GetDrawEffectValue;

  if BodySurface <> nil then
  begin
    if Appearance = 51 then
    begin //蓖脚 npc
      DrawEffSurface(dsurface, BodySurface, dx + px + ShiftX, dy + py + ShiftY, True, ceff);
      DrawEffSurface(dsurface, BodySurface, dx + px + ShiftX, dy + py + ShiftY, True, ceff);
    end
    else
      DrawEffSurface(dsurface, BodySurface, dx + px + ShiftX, dy + py + ShiftY, blend, ceff);
  end;
// inherited DrawChr(dsurface, dx, dy, blend);
end;

procedure TNpcActor.DrawEff(dsurface: TAsphyreCanvas; dx, dy: integer);
begin
  if BoUseEffect then
    if EffectSurface <> nil then
    begin
      dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, EffectSurface, 1);
    end;
end;




{============================== HUMActor =============================}

//            人物

{-------------------------------}

constructor THumActor.Create;
begin
  inherited Create;
  HairSurface := nil;
  WeaponSurface := nil;
  WingSurface := nil;
  WeaponEffectSurface := nil;
  BoWeaponEffect := FALSE;

  WingFrameTime := 150;
  WingStartTime := GetTickCount;
  WingCurrentFrame := 0;
  WingOffset := 0;

  WeaponEffectFrameTime := 150;
  WeaponEffectStartTime := GetTickCount;
  WeaponEffectCurrentFrame := 0;
  WeaponEffectOffset := HUMANFRAME * 4;

  H50LevelEffectSurface := nil;
  H50LevelEffectFrameTime := 150;
  H50LevelEffectStartTime := GetTickCount;
  H50LevelEffectCurrentFrame := 0;
  H50LevelEffectOffset := 312;

  FoodStickDayEffectSurface := nil;
  FoodStickDayEffectSurface2 := nil;
  FoodStickDayEffectFrameTime := 120;
  FoodStickDayEffectStartTime := GetTickCount;
  FoodStickDayEffectCurrentFrame := 0;
  FoodStickDayEffectOffset := 440;
  FoodStickDayEffectOffset2 := 420;

{   HWriterEffectSurface := nil;
   HWriterEffectFrameTime := 90;
   HWriterEffectStartTime := GetTickCount;
   HWriterEffectCurrentFrame := 0;
   HWriterEffectOffset := 328;}
  m_StallMgr := TStallMgr.Create;
end;

destructor THumActor.Destroy;
begin
  inherited Destroy;
end;

procedure THumActor.CalcActorFrame;
var
  haircount: integer;
begin
  BoUseMagic := FALSE;
  BoHitEffect := FALSE;
  currentframe := -1;
  WarModeCount := 4;
   //human
  hair := HAIRfeature(feature);         //函版等促.
//   dress  := DRESSfeature (Feature); //公怕焊矫 渴哎酒涝栏搁 巩力啊 凳, 弊贰辑 林籍 贸府
//      DScreen.AddChatBoardString ('CalcActorFrame() dress=> '+IntToStr(dress), clYellow, clRed);
  weapon := WEAPONfeature(feature);
  Effect := Effectfeature (FeatureEx); //翅膀增加
  BodyOffset := HUMANFRAME * (dress); //Sex; //巢磊0, 咯磊1

  haircount := WHairImg.ImageCount div HUMANFRAME div 2;
  if hair > haircount - 1 then
    hair := haircount - 1;
  hair := hair * 2;
  if hair > 1 then
    HairOffset := HUMANFRAME * (hair + Sex)
  else
    HairOffset := -1;
  WeaponOffset := HUMANFRAME * weapon; //(weapon*2 + Sex);
  //翅膀增加
   if (Effect = 50) then begin
      WingOffset := 352;
   end else
   if Effect <> 0 then
     WingOffset := (Effect - 1) * HUMANFRAME;
  {if dress = 18 then
    WingOffset := 0                  // 天衣无缝(巢)
  else if dress = 19 then
    WingOffset := HUMANFRAME    // 天衣无缝(咯)
  else if dress = 20 then
    WingOffset := HUMANFRAME * 2  // 玫锋阂荤狼(巢)
  else if dress = 21 then
    WingOffset := HUMANFRAME * 3 // 玫锋阂荤狼(咯)
  else if dress in [22, 23] then
    WingOffset := 352; // 50饭骇渴

  if weapon = 76 then
    WeaponEffectOffset := HUMANFRAME * 4        // 颇包柳八 捞棋飘(巢)
  else if weapon = 77 then
    WeaponEffectOffset := HUMANFRAME * 5;  // 颇包柳八 捞棋飘(咯) }

  case CurrentAction of
    SM_TURN:
      begin
        startframe := HA.ActStand.start + dir * (HA.ActStand.frame + HA.ActStand.skip);
        endframe := startframe + HA.ActStand.frame - 1;
        frametime := HA.ActStand.ftime;
        starttime := GetTickCount;
        defframecount := HA.ActStand.frame;
        Shift(dir, 0, 0, endframe - startframe + 1);
      end;
    SM_WALK, SM_BACKSTEP:
      begin
        startframe := HA.ActWalk.start + dir * (HA.ActWalk.frame + HA.ActWalk.skip);
        endframe := startframe + HA.ActWalk.frame - 1;
        frametime := HA.ActWalk.ftime;
        starttime := GetTickCount;
        maxtick := HA.ActWalk.UseTick;
        curtick := 0;
            //WarMode := FALSE;
        movestep := 1;
        if CurrentAction = SM_BACKSTEP then
          Shift(GetBack(dir), movestep, 0, endframe - startframe + 1)
        else
          Shift(dir, movestep, 0, endframe - startframe + 1);
      end;
    SM_RUSH:
      begin
        if RushDir = 0 then
        begin
          RushDir := 1;
          startframe := HA.ActRushLeft.start + dir * (HA.ActRushLeft.frame + HA.ActRushLeft.skip);
          endframe := startframe + HA.ActRushLeft.frame - 1;
          frametime := HA.ActRushLeft.ftime;
          starttime := GetTickCount;
          maxtick := HA.ActRushLeft.UseTick;
          curtick := 0;
          movestep := 1;
          Shift(dir, 1, 0, endframe - startframe + 1);
        end
        else
        begin
          RushDir := 0;
          startframe := HA.ActRushRight.start + dir * (HA.ActRushRight.frame + HA.ActRushRight.skip);
          endframe := startframe + HA.ActRushRight.frame - 1;
          frametime := HA.ActRushRight.ftime;
          starttime := GetTickCount;
          maxtick := HA.ActRushRight.UseTick;
          curtick := 0;
          movestep := 1;
          Shift(dir, 1, 0, endframe - startframe + 1);
        end;
      end;
    SM_RUSHKUNG:
      begin
        startframe := HA.ActRun.start + dir * (HA.ActRun.frame + HA.ActRun.skip);
        endframe := startframe + HA.ActRun.frame - 1;
        frametime := HA.ActRun.ftime;
        starttime := GetTickCount;
        maxtick := HA.ActRun.UseTick;
        curtick := 0;
        movestep := 1;
        Shift(dir, movestep, 0, endframe - startframe + 1);
      end;
      {SM_BACKSTEP:
         begin
            startframe := pm.ActWalk.start + (pm.ActWalk.frame - 1) + Dir * (pm.ActWalk.frame + pm.ActWalk.skip);
            endframe := startframe - (pm.ActWalk.frame - 1);
            frametime := pm.ActWalk.ftime;
            starttime := GetTickCount;
            maxtick := pm.ActWalk.UseTick;
            curtick := 0;
            movestep := 1;
            Shift (GetBack(Dir), movestep, 0, endframe-startframe+1);
         end;  }
    SM_SITDOWN:
      begin
        startframe := HA.ActSitdown.start + dir * (HA.ActSitdown.frame + HA.ActSitdown.skip);
        endframe := startframe + HA.ActSitdown.frame - 1;
        frametime := HA.ActSitdown.ftime;
        starttime := GetTickCount;
      end;
    SM_RUN:
      begin
        startframe := HA.ActRun.start + dir * (HA.ActRun.frame + HA.ActRun.skip);
        endframe := startframe + HA.ActRun.frame - 1;
        frametime := HA.ActRun.ftime;
        starttime := GetTickCount;
        maxtick := HA.ActRun.UseTick;
        curtick := 0;
            //WarMode := FALSE;
        if CurrentAction = SM_RUN then
          movestep := 2
        else
          movestep := 1;
            //movestep := 2;
        Shift(dir, movestep, 0, endframe - startframe + 1);
      end;
    SM_THROW:
      begin
        startframe := HA.ActHit.start + dir * (HA.ActHit.frame + HA.ActHit.skip);
        endframe := startframe + HA.ActHit.frame - 1;
        frametime := HA.ActHit.ftime;
        starttime := GetTickCount;
        WarMode := TRUE;
        WarModeTime := GetTickCount;
        BoThrow := TRUE;
        Shift(dir, 0, 0, 1);
      end;
      // 2003/03/15 脚痹公傍
    SM_HIT, SM_POWERHIT, SM_LONGHIT, SM_WIDEHIT, SM_FIREHIT, SM_CROSSHIT, SM_TWINHIT:
      begin
//          DScreen.AddSysMsg (UserName +' ''s Current Action =' + IntToStr(CurrentAction));
        startframe := HA.ActHit.start + dir * (HA.ActHit.frame + HA.ActHit.skip);
        endframe := startframe + HA.ActHit.frame - 1;
        frametime := HA.ActHit.ftime;
        starttime := GetTickCount;
        WarMode := TRUE;
        WarModeTime := GetTickCount;
        if (CurrentAction = SM_POWERHIT) then
        begin
          BoHitEffect := TRUE;
          MagLight := 2;
          HitEffectNumber := 1;
        end;
        if (CurrentAction = SM_LONGHIT) then
        begin
          BoHitEffect := TRUE;
          MagLight := 2;
          HitEffectNumber := 2;
        end;
        if (CurrentAction = SM_WIDEHIT) then
        begin
          BoHitEffect := TRUE;
          MagLight := 2;
          HitEffectNumber := 3;
        end;
        if (CurrentAction = SM_FIREHIT) then
        begin
          BoHitEffect := TRUE;
          MagLight := 2;
          HitEffectNumber := 4;
        end;
            // 2003/03/15 脚痹公傍
        if (CurrentAction = SM_CROSSHIT) then
        begin
          BoHitEffect := TRUE;
          MagLight := 2;
          HitEffectNumber := 6;
        end;
        if (CurrentAction = SM_TWINHIT) then
        begin
          BoHitEffect := TRUE;
          MagLight := 2;
          HitEffectNumber := 7;
        end;

        Shift(dir, 0, 0, 1);
      end;
    SM_HEAVYHIT:
      begin
        startframe := HA.ActHeavyHit.start + dir * (HA.ActHeavyHit.frame + HA.ActHeavyHit.skip);
        endframe := startframe + HA.ActHeavyHit.frame - 1;
        frametime := HA.ActHeavyHit.ftime;
        starttime := GetTickCount;
        WarMode := TRUE;
        WarModeTime := GetTickCount;
        Shift(dir, 0, 0, 1);
      end;
    SM_BIGHIT:
      begin
        startframe := HA.ActBigHit.start + dir * (HA.ActBigHit.frame + HA.ActBigHit.skip);
        endframe := startframe + HA.ActBigHit.frame - 1;
        frametime := HA.ActBigHit.ftime;
        starttime := GetTickCount;
        WarMode := TRUE;
        WarModeTime := GetTickCount;
        Shift(dir, 0, 0, 1);
      end;
    SM_SPELL:
      begin
        startframe := HA.ActSpell.start + dir * (HA.ActSpell.frame + HA.ActSpell.skip);
        endframe := startframe + HA.ActSpell.frame - 1;
        frametime := HA.ActSpell.ftime;
        starttime := GetTickCount;
        CurEffFrame := 0;
        BoUseMagic := TRUE;
        case CurMagic.EffectNumber of
          22:
            begin //汾汲拳
              MagLight := 4;  //汾汲拳
              SpellFrame := 10; //汾汲拳绰 10 橇贰烙栏肺 函版
            end;
          26:
            begin //沤扁颇楷
              MagLight := 2;
              SpellFrame := 20;
              frametime := frametime div 2;
            end;
          35:
            begin //公必柳扁 PDS 2003-03-27
              MagLight := 2;  //公必柳扁
              SpellFrame := 15; //公必柳扁绰 15 橇贰烙栏肺 函版
            end;
          43:
            begin // 荤磊饶
              MagLight := 2;
              SpellFrame := 20;
              frametime := 70;
            end;
          44:
            begin // 傍颇级
              startframe := HA.ActBigHit.start + dir * (HA.ActBigHit.frame + HA.ActBigHit.skip);
              endframe := startframe + HA.ActBigHit.frame - 1;
//                  frametime := HA.ActBigHit.ftime;
              frametime := 50;   //2004/09/09 傍颇级 加档 狐福霸
              starttime := GetTickCount;
              MagLight := 2;
              SpellFrame := 20;
              SKillStartTime := GetTickCount;
              SKillCurrentFrame := 0;
//                  SKillFrametime    := 80;
              SKillFrametime := frametime;
              BoHitEffect := TRUE;
              HitEffectNumber := 8;
              PlaySound(weaponsound);
              PlaySound(s_twinhit);
            end;
          45:
            begin //拳锋扁堪
              MagLight := 2;
              SpellFrame := 10; //23;
              frametime := 100; //100;
              FrmMain.UseNormalEffect(NE_FIRECIRCLE, self.XX, self.YY); // 付过 矫怜吝 框流老荐 乐霸 窍妨绊
            end;
          47:
            begin // 器铰八
              MagLight := 2;
              SpellFrame := 10;
              frametime := 80;
            end;
          50:
            begin //公必柳扁 PDS 2003-03-27
              MagLight := 2;  //公必柳扁
              SpellFrame := 10; //公必柳扁绰 15 橇贰烙栏肺 函版
              WarMode := True;
              WarModeTime := GetTickCount;
            end;
          52:
            begin // Blizzard
              MagLight := 2;
              SpellFrame := 10; //23;
                  //   frametime := 100;//100;
              if state and $00000400{STATE_MYSTICSKY}   = 0 then
              begin
                SpellGuideMode := True;
                SpellGuideModeTime := GetTickCount;
              end;
              WarModeCount := 6;
              WarMode2 := True;
            end;
          53:
            begin // MeteorStrike
              PlaySound(10532);
              MagLight := 2;
              SpellFrame := 10; //23;
                  //   frametime := 100;//100;
              if state and $00000400{STATE_MYSTICSKY}   = 0 then
              begin
                SpellGuideMode := True;
                SpellGuideModeTime := GetTickCount;
              end;
              WarModeCount := 6;
              WarMode2 := True;
            end;

          56:
            begin
              case ChickAppearance of
                0..2, 7:
                  startframe := HA.ActFlareHit.start + dir * (HA.ActFlareHit.frame + HA.ActFlareHit.skip);
                10..12:
                  startframe := HA.ActFlareHit.start + 200 + dir * (HA.ActFlareHit.frame + HA.ActFlareHit.skip);
                255:
                  startframe := HA.ActFlareHit.start + 64 + dir * (HA.ActFlareHit.frame + HA.ActFlareHit.skip);
              end;
              endframe := startframe + HA.ActFlareHit.frame - 1;
              frametime := 80;
              MagLight := 2;
              WarMode := True;
              WarModeTime := GetTickCount;
              BoUseMagic := FALSE;
              Shift(dir, 0, 0, 1);
            end;
          57:
            begin          //葫堪贱
//              StartFrame := dir * (HA.ActStand.frame + HA.ActStand.skip);
//              EndFrame := StartFrame + HA.ActStand.frame - 1;
//              FrameTime := 90;
//              StartTime := GetTickCount;
//              MagLight := 2;
//              SpellFrame := 10;
//              PlaySound(10572);
//              WarModeTime := GetTickCount;
//              WarMode := True;

              FrameTime := 85;
              MagLight := 2;
              SpellFrame := 10; //23;
              PlaySound(10573);
             //PlaySound(10532);
                 //   frametime := 100;//100;

              if state and $00000400{STATE_MYSTICSKY}     = 0 then
              begin
                SpellGuideMode := True;
                SpellGuideModeTime := GetTickCount;
              end;
            end;

          77:
            begin
              PlaySound(10730);
              PlaySound(10735);
            end;
        else
          begin //.....  措雀汗贱, 荤磊辣雀, 葫汲浅
            MagLight := 2;
            SpellFrame := DEFSPELLFRAME;
          end;
        end;
        WaitMagicRequest := GetTickCount;
        WarMode := TRUE;
        WarModeTime := GetTickCount;
        Shift(dir, 0, 0, 1);
      end;
            (*SM_READYFIREHIT:
         begin
            startframe := HA.ActFireHitReady.start + Dir * (HA.ActFireHitReady.frame + HA.ActFireHitReady.skip);
            endframe := startframe + HA.ActFireHitReady.frame - 1;
            frametime := HA.ActFireHitReady.ftime;
            starttime := GetTickCount;

            BoHitEffect := TRUE;
            HitEffectNumber := 4;
            MagLight := 2;

            CurGlimmer := 0;
            MaxGlimmer := 6;

            WarMode := TRUE;
            WarModeTime := GetTickCount;
            Shift (Dir, 0, 0, 1);
         end; *)
    SM_STRUCK:
     if  (g_bo稳如泰山) and (not g_bo绝对泰山) then
      begin
        startframe := HA.ActStruck.start + dir * (HA.ActStruck.frame + HA.ActStruck.skip);
        endframe := startframe + HA.ActStruck.frame - 1;
        frametime := 50; //HA.ActStruck.ftime;
        //frametime := struckframetime; //HA.ActStruck.ftime;  人物后仰速度设置
        starttime := GetTickCount;
        Shift(dir, 0, 0, 1);
        genanicounttime := GetTickCount;
        CurBubbleStruck := 0;
        end
        else
        begin
        startframe := HA.ActStruck.start + dir * (HA.ActStruck.frame + HA.ActStruck.skip);
        endframe := startframe + HA.ActStruck.frame - 1;
        //frametime := 50; //HA.ActStruck.ftime;
        frametime := struckframetime; //HA.ActStruck.ftime;  人物后仰速度设置
        starttime := GetTickCount;
        Shift(dir, 0, 0, 1);

        genanicounttime := GetTickCount;
        CurBubbleStruck := 0;
      end;
    SM_NOWDEATH:
      begin
        startframe := HA.ActDie.start + dir * (HA.ActDie.frame + HA.ActDie.skip);
        endframe := startframe + HA.ActDie.frame - 1;
        frametime := HA.ActDie.ftime;
        starttime := GetTickCount;
      end;
  end;
end;

procedure THumActor.DefaultMotion;
begin
  inherited DefaultMotion;
  if (Dress in [22, 23]) and (currentframe < 536) then
  begin
    if GetTickCount - WingStartTime > 100 then
    begin
      if WingCurrentFrame < 19 then
        Inc(WingCurrentFrame)
      else
      begin
        if not Bo50DressHEffect then
          Bo50DressHEffect := True
        else
          Bo50DressHEffect := False;
        WingCurrentFrame := 0;
      end;
//         DScreen.AddSysMsg ('THumActor.DefaultMotion=>(Dress in [22,23])');
      WingStartTime := GetTickCount;
    end;
    WingSurface := WEffectImg.GetCachedImage(WingOffset + WingCurrentFrame, epx, epy);
  end
  else if (Dress in [18, 19, 20, 21]) and (currentframe < 64) then
  begin
    if GetTickCount - WingStartTime > WingFrametime then
    begin
      if WingCurrentFrame < 7 then
        Inc(WingCurrentFrame)
      else
        WingCurrentFrame := 0;
//         DScreen.AddSysMsg ('THumActor.DefaultMotion=>(Dress in [Wing])');
      WingStartTime := GetTickCount;
    end;
    WingSurface := WHumWing.GetCachedImage(WingOffset + dir * 8 + WingCurrentFrame, epx, epy);
  end;
  if currentframe > 535 then
    Bo50DressHEffect := False;

  if Bo50LevelEffect then
  begin
    if GetTickCount - H50LevelEffectStartTime > H50LevelEffectFrameTime then
    begin
      if H50LevelEffectCurrentFrame < 7 then
        Inc(H50LevelEffectCurrentFrame)
      else
      begin
        H50LevelEffectCurrentFrame := 0;
        Bo50LevelHEffect := not Bo50LevelHEffect;
      end;
      H50LevelEffectStartTime := GetTickCount;
    end;
    H50LevelEffectSurface := WEffectImg.GetCachedImage(H50LevelEffectOffset + H50LevelEffectCurrentFrame, epx2, epy2);
  end;

  if FoodStickType > 0 then
  begin
    if GetTickCount - FoodStickDayEffectStartTime > FoodStickDayEffectFrameTime then
    begin
      if FoodStickDayEffectCurrentFrame < 14 then
        Inc(FoodStickDayEffectCurrentFrame)
      else
      begin
        FoodStickDayEffectCurrentFrame := 0;
      end;
      FoodStickDayEffectStartTime := GetTickCount;
    end;
    FoodStickDayEffectSurface := WEffectImg.GetCachedImage(FoodStickDayEffectOffset + FoodStickDayEffectCurrentFrame, epx3, epy3);
    FoodStickDayEffectSurface2 := WEffectImg.GetCachedImage(FoodStickDayEffectOffset2 + FoodStickDayEffectCurrentFrame, epx4, epy4);
  end;

{   if BoWriterEffect then begin
      if GetTickCount - HWriterEffectStartTime > HWriterEffectFrameTime then begin
         if HWriterEffectCurrentFrame < 9 then
            Inc (HWriterEffectCurrentFrame)
         else begin
            HWriterEffectCurrentFrame := 0;
            BoWriterHEffect := Not BoWriterHEffect;
         end;
         HWriterEffectStartTime := GetTickCount;
      end;
      HWriterEffectSurface := WEffectImg.GetCachedImage (HWriterEffectOffset + HWriterEffectCurrentFrame, epx3, epy3);
   end;}

end;

function THumActor.GetDefaultFrame(wmode: Boolean): integer;
var
  cf, dr: integer;
  pm: PTMonsterAction;
begin
   //GlimmingMode := FALSE;
   //dr := Dress div 2;            //HUMANFRAME * (dr)
  if Death then
    Result := HA.ActDie.start + dir * (HA.ActDie.frame + HA.ActDie.skip) + (HA.ActDie.frame - 1)
  else if wmode then
  begin
      //GlimmingMode := TRUE;
    Result := HA.ActWarMode.start + dir * (HA.ActWarMode.frame + HA.ActWarMode.skip);
  end
  else
  begin
    defframecount := HA.ActStand.frame;
    if currentdefframe < 0 then
      cf := 0
    else if currentdefframe >= HA.ActStand.frame then
      cf := 0 //HA.ActStand.frame-1
    else
      cf := currentdefframe;
    Result := HA.ActStand.start + dir * (HA.ActStand.frame + HA.ActStand.skip) + cf;
  end;
end;

procedure THumActor.RunFrameAction(frame: integer);
var
  meff: TMapEffect;
  event: TClEvent;
  mfly: TFlyingAxe;
begin
  BoHideWeapon := FALSE;
  if CurrentAction = SM_HEAVYHIT then
  begin
    if (frame = 5) and (BoDigFragment) then
    begin
      BoDigFragment := FALSE;
      meff := TMapEffect.Create(8 * dir, 3, XX, YY);
      meff.ImgLib := WEffectImg;
      meff.NextFrameTime := 80;
      PlaySound(s_strike_stone);
         //PlaySound (s_drop_stonepiece);
      PlayScene.EffectList.Add(meff);
      event := EventMan.GetEvent(XX, YY, ET_PILESTONES);
      if event <> nil then
        event.EventParam := event.EventParam + 1;
    end;
  end;
  if CurrentAction = SM_THROW then
  begin
    if (frame = 3) and (BoThrow) then
    begin
      BoThrow := FALSE;
      mfly := TFlyingAxe(PlayScene.NewFlyObject(self, XX, YY, TargetX, TargetY, TargetRecog, mtFlyAxe));
      if mfly <> nil then
      begin
        TFlyingAxe(mfly).ReadyFrame := 40;
        mfly.ImgLib := WMon3Img;
        mfly.FlyImageBase := FLYOMAAXEBASE;
      end;

    end;
    if frame >= 3 then
      BoHideWeapon := TRUE;
  end;
end;

procedure THumActor.DoWeaponBreakEffect;
begin
  BoWeaponEffect := TRUE;
  CurWpEffect := 0;
end;

procedure THumActor.Run;

  function MagicTimeOut: Boolean;
  begin
//      if self = Myself then begin
    Result := GetTickCount - WaitMagicRequest > 3000;
//      end else
//         Result := GetTickCount - WaitMagicRequest > 2000;
    if Result then
      CurMagic.ServerMagicCode := 0;
  end;

var
  prv: integer;
  frametimetime: longword;
  bofly: Boolean;
begin
  if GetTickCount - genanicounttime > 120 then
  begin //巫术之幕等…动画效果
    genanicounttime := GetTickCount;
    Inc(GenAniCount);
    if GenAniCount > 100000 then
      GenAniCount := 0;
    Inc(CurBubbleStruck);
  end;
  if BoWeaponEffect then
  begin  //武器提高/破碎效果
    if GetTickCount - wpeffecttime > 120 then
    begin
      wpeffecttime := GetTickCount;
      Inc(CurWpEffect);
      if CurWpEffect >= MAXWPEFFECTFRAME then
        BoWeaponEffect := FALSE;
    end;
  end;

  if (CurrentAction = SM_WALK) or (CurrentAction = SM_BACKSTEP) or (CurrentAction = SM_RUN) or (CurrentAction = SM_RUSH) or (CurrentAction = SM_RUSHKUNG) then
    exit;

  msgmuch := FALSE;
  if self <> Myself then
  begin
    if MsgList.Count >= 2 then
      msgmuch := TRUE;
  end;

   //荤款靛 瓤苞
  RunActSound(currentframe - startframe);
  RunFrameAction(currentframe - startframe);

  prv := currentframe;
  if CurrentAction <> 0 then
  begin
    if (currentframe < startframe) or (currentframe > endframe) then
      currentframe := startframe;

//      if (self <> Myself) and (BoUseMagic) then begin
//         frametimetime := Round(frametime / 1.8);
//      end else begin
    if msgmuch then
      frametimetime := Round(frametime * 2 / 3)
    else
      frametimetime := frametime; //2004/04/07 加档包访 荐沥
//      end;

    if GetTickCount - starttime > frametimetime then
    begin
      if currentframe < endframe then
      begin

            //如果是魔法，请接收服务器的信号，确认成功/失败。
            //结束最后一个动作
        if BoUseMagic then
        begin
          if (CurEffFrame = SpellFrame - 2) or (MagicTimeOut) then
          begin //等待结束
            if (CurMagic.ServerMagicCode >= 0) or (MagicTimeOut) then
            begin //从服务器收到的结果。还没来就等著。
              Inc(currentframe);
              Inc(CurEffFrame);
              starttime := GetTickCount;
            end;
          end
          else
          begin
            if currentframe < endframe - 1 then
              Inc(currentframe);
            Inc(CurEffFrame);
            starttime := GetTickCount;
          end;
        end
        else
        begin
          Inc(currentframe);
          starttime := GetTickCount;
        end;

      end
      else
      begin
        if self = Myself then
        begin
          if FrmMain.ServerAcceptNextAction then
          begin
            CurrentAction := 0;
            BoUseMagic := FALSE;
          end;
        end
        else
        begin
          CurrentAction := 0; //悼累 肯丰
          BoUseMagic := FALSE;
        end;
        BoHitEffect := FALSE;
      end;
      if BoUseMagic then
      begin
        if CurEffFrame = SpellFrame - 1 then
        begin //付过 惯荤 矫痢
               //付过 惯荤
          if CurMagic.ServerMagicCode > 0 then
          begin
            with CurMagic do
              PlayScene.NewMagic(self, ServerMagicCode, EffectNumber, XX, YY, TargX, TargY, Target, EffectType, Recusion, AniTime, bofly);
            if bofly then
              PlaySound(magicfiresound)
            else
              PlaySound(magicexplosionsound);
          end;
          if self = Myself then
            LatestSpellTime := GetTickCount;
          CurMagic.ServerMagicCode := 0;
        end;
      end;

    end;
    if race = 0 then
      currentdefframe := 0
    else
      currentdefframe := -10;
    defframetime := GetTickCount;
  end
  else
  begin
    if GetTickCount - smoothmovetime > 200 then
    begin
      if GetTickCount - defframetime > 500 then
      begin
        defframetime := GetTickCount;
        Inc(currentdefframe);
        if currentdefframe >= defframecount then
          currentdefframe := 0;
      end;
      DefaultMotion;
    end;
  end;

  if (prv <> currentframe) or bUpdateShowTrans then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface;
    bUpdateShowTrans := False;
  end;

end;

function THumActor.Light: integer;
var
  l: integer;
begin
  l := ChrLight;
  if l < MagLight then
  begin
    if BoUseMagic or BoHitEffect then
      l := MagLight;
  end;
  Result := l;
end;

procedure THumActor.LoadSurface;
begin
  if bShowTrans > 0 then
    BodySurface := WTranImg.GetCachedImage(BodyOffset + currentframe, px, py)
  else
  BodySurface := WHumImg.GetCachedImage(BodyOffset + currentframe, px, py);
  if HairOffset >= 0 then
    HairSurface := WHairImg.GetCachedImage(HairOffset + currentframe, hpx, hpy)
  else
    HairSurface := nil;
  if (Dress in [22, 23]) and (currentframe < 536) then
  begin
    if GetTickCount - WingStartTime > 100 then
    begin
      if WingCurrentFrame < 19 then
        Inc(WingCurrentFrame)
      else
      begin
        if not Bo50DressHEffect then
          Bo50DressHEffect := True
        else
          Bo50DressHEffect := False;
        WingCurrentFrame := 0;
      end;

//         DScreen.AddSysMsg ('SF=>'+ IntToStr(Dir*8)+' CF=>'+ IntToStr(WingCurrentFrame)+' THumActor');
      WingStartTime := GetTickCount;
    end;
    WingSurface := WEffectImg.GetCachedImage(WingOffset + WingCurrentFrame, epx, epy);
  end
  else if (Dress in [18, 19, 20, 21]) and (currentframe < 64) then
  begin
    if GetTickCount - WingStartTime > WingFrametime then
    begin
      if WingCurrentFrame < 7 then
        Inc(WingCurrentFrame)
      else
        WingCurrentFrame := 0;
//         DScreen.AddSysMsg ('SF=>'+ IntToStr(Dir*8)+' CF=>'+ IntToStr(WingCurrentFrame)+' THumActor');
      WingStartTime := GetTickCount;
    end;
    WingSurface := WHumWing.GetCachedImage(WingOffset + dir * 8 + WingCurrentFrame, epx, epy)
  end
  else if Dress in [18, 19, 20, 21] then
    WingSurface := WHumWing.GetCachedImage(WingOffset + currentframe, epx, epy);

  if currentframe > 535 then
    Bo50DressHEffect := False;

  if Bo50LevelEffect then
  begin
    if GetTickCount - H50LevelEffectStartTime > H50LevelEffectFrameTime then
    begin
      if H50LevelEffectCurrentFrame < 7 then
        Inc(H50LevelEffectCurrentFrame)
      else
      begin
        H50LevelEffectCurrentFrame := 0;
        Bo50LevelHEffect := not Bo50LevelHEffect;
      end;
      H50LevelEffectStartTime := GetTickCount;
    end;
    H50LevelEffectSurface := WEffectImg.GetCachedImage(H50LevelEffectOffset + H50LevelEffectCurrentFrame, epx2, epy2);
  end;

  if FoodStickType > 0 then
  begin
    if GetTickCount - FoodStickDayEffectStartTime > FoodStickDayEffectFrameTime then
    begin
      if FoodStickDayEffectCurrentFrame < 14 then
        Inc(FoodStickDayEffectCurrentFrame)
      else
      begin
        FoodStickDayEffectCurrentFrame := 0;
      end;
      FoodStickDayEffectStartTime := GetTickCount;
    end;
    FoodStickDayEffectSurface := WEffectImg.GetCachedImage(FoodStickDayEffectOffset + FoodStickDayEffectCurrentFrame, epx3, epy3);
    FoodStickDayEffectSurface2 := WEffectImg.GetCachedImage(FoodStickDayEffectOffset2 + FoodStickDayEffectCurrentFrame, epx4, epy4);
  end;

{   if (Weapon in [76,77]) and (currentframe < 64) then begin
      if GetTickCount - WeaponEffectStartTime > WeaponEffectFrametime then begin
         if WeaponEffectCurrentFrame < 7 then
            Inc (WeaponEffectCurrentFrame)
         else
            WeaponEffectCurrentFrame := 0;
//         DScreen.AddSysMsg ('THumActor.DefaultMotion=>(Dress in [Wing])');
         WeaponEffectStartTime := GetTickCount;
      end;
      WeaponEffectSurface := WHumWing.GetCachedImage (WeaponEffectOffset + Dir*8 + WeaponEffectCurrentFrame, wpx2, wpy2);
   end;}
{   if BoWriterEffect then begin
      if GetTickCount - HWriterEffectStartTime > HWriterEffectFrameTime then begin
         if HWriterEffectCurrentFrame < 9 then
            Inc (HWriterEffectCurrentFrame)
         else begin
            HWriterEffectCurrentFrame := 0;
            BoWriterHEffect := Not BoWriterHEffect;
         end;
         HWriterEffectStartTime := GetTickCount;
      end;
      HWriterEffectSurface := WEffectImg.GetCachedImage (HWriterEffectOffset + HWriterEffectCurrentFrame, epx3, epy3);
   end;}

  WeaponSurface := WWeapon.GetCachedImage(WeaponOffset + currentframe, wpx, wpy);
  WeaponEffectSurface := WHumWing.GetCachedImage(WeaponEffectOffset + currentframe, wpx2, wpy2);

end;

procedure THumActor.DrawChr(dsurface: TAsphyreCanvas; dx, dy: integer; blend: Boolean; WingDraw: Boolean);
var
  idx, ax, ay: integer;
  dd, d: TAsphyreLockableTexture;
  ceff: TColorEffect;
  wimg: TWMImages;
  m_nShiftX, m_nShiftY: Integer;
begin
  if not (dir in [0..7]) then
    exit;
  if GetTickCount - loadsurfacetime > (FREE_TEXTURE_TIME div 2) then
  begin
    loadsurfacetime := GetTickCount;
    LoadSurface; //bodysurface殿捞 loadsurface甫 促矫 何福瘤 臼酒 皋葛府啊 橇府登绰 巴阑 阜澜
  end;

  ceff := GetDrawEffectValue;

//-摆摊
//Stall
  if WingDraw and m_StallMgr.OnSale then
  begin
    if not dir in [1, 3, 5, 7] then
      dir := 5;
    dd := nil;
    case dir of    //7...18 之间
      1:
        begin
          case m_StallMgr.StallType of
            0:
              begin
                ax := -20;
                ay := -22;
                dd := WProgUse.Images[743];
              end;
            1:
              begin
                ax := -6;
                ay := -40;
                dd := WProgUse.Images[753];
              end;
            2:
              begin
                ax := -18;
                ay := -54;
                dd := WProgUse.Images[763];
              end;
          end;
        end;
      3:
        begin
          case m_StallMgr.StallType of
            0:
              begin
                ax := -25;
                ay := -10;
                dd := WProgUse.Images[740];
              end;
          end;
        end;
      5:
        begin
          case m_StallMgr.StallType of
            0:
              begin
                ax := -47;
                ay := -10;
                dd := WProgUse.Images[742];
              end;
          end;
        end;
      7:
        begin
          case m_StallMgr.StallType of
            0:
              begin
                ax := -52;
                ay := -30;
                dd := WProgUse.Images[741];
              end;
            1:
              begin
                ax := -46;
                ay := -44;
                dd := WProgUse.Images[751];
              end;
            2:
              begin
                ax := -56;
                ay := -48;
                dd := WProgUse.Images[761];
              end;
          end;
        end;
    end;
    m_nShiftX := dx + ShiftX;
    m_nShiftY := dy + ShiftY;
    if dd <> nil then
    begin
      dsurface.Draw(m_nShiftX + ax, m_nShiftY + ay, dd.ClientRect, dd, True);
    end;
  end;
//-摆摊
  if race = 0 then
  begin
    if (currentframe >= 0) and (currentframe <= 599) then
      wpord := WORDER[Sex, currentframe];

// 2锅 葛靛 --------------------------------------------------------------------
    if bShowTrans = 0 then
    begin
    if Dress in [18, 19, 20, 21] then
    begin
      if self = Myself then
      begin
        if blend then
          if ((dir = DR_DOWN) or (dir = DR_DOWNRIGHT) or (dir = DR_DOWNLEFT)) and (WingSurface <> nil) and (not WingDraw) then
            dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1)
          else if ((dir = DR_DOWN) or (dir = DR_DOWNRIGHT) or (dir = DR_DOWNLEFT)) and (WingSurface <> nil) and WingDraw then
            dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1);
      end
      else
      begin
        if ((FocusCret <> nil) or (MagicTarget <> nil)) and blend and ((dir = DR_DOWN) or (dir = DR_DOWNRIGHT) or (dir = DR_DOWNLEFT)) and (WingSurface <> nil) and (not WingDraw) then
          dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1)
        else if ((dir = DR_DOWN) or (dir = DR_DOWNRIGHT) or (dir = DR_DOWNLEFT)) and (WingSurface <> nil) and WingDraw then
          dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1);
      end;
    end;
    end;

// 2锅 葛靛 --------------------------------------------------------------------
    if bShowTrans = 0 then
    begin
    if (wpord = 0) and (not blend) and (Weapon >= 2) and (WeaponSurface <> nil) and (not BoHideWeapon) then
    begin
      DrawEffSurface(dsurface, WeaponSurface, dx + wpx + ShiftX, dy + wpy + ShiftY, blend, ceNone);  //漠篮 祸捞 救函窃
      if Weapon in [76, 77] then
        dsurface.DrawBlend(dx + wpx2 + ShiftX, dy + wpy2 + ShiftY, WeaponEffectSurface, 1);
    end;
    end;

      //个烹 弊府绊
    if BodySurface <> nil then
      DrawEffSurface(dsurface, BodySurface, dx + px + ShiftX, dy + py + ShiftY, blend, ceff);

    if bShowTrans = 0 then
    begin
      if not (Dress in [24, 25]) then
        if HairSurface <> nil then
          DrawEffSurface(dsurface, HairSurface, dx + hpx + ShiftX, dy + hpy + ShiftY, blend, ceff);

      //焊捞绰 阿档俊 蝶扼辑 个,赣府,公扁甫 弊府绰 鉴辑啊 崔扼柳促.
      if (wpord = 1) and {(not blend) and} (Weapon >= 2) and (WeaponSurface <> nil) and (not BoHideWeapon) then
      begin
        DrawEffSurface(dsurface, WeaponSurface, dx + wpx + ShiftX, dy + wpy + ShiftY, blend, ceNone);
        if Weapon in [76, 77] then
          dsurface.DrawBlend(dx + wpx2 + ShiftX, dy + wpy2 + ShiftY, WeaponEffectSurface, 1);
      end;
    end;

// 2锅葛靛 ---------------------------------------------------------------------
    if bShowTrans = 0 then
    begin
      if Dress in [18, 19, 20, 21] then
      begin
        if self = Myself then
        begin
          if blend then
            if ((dir = DR_UP) or (dir = DR_UPLEFT) or (dir = DR_UPRIGHT) or (dir = DR_LEFT) or (dir = DR_RIGHT)) and (WingSurface <> nil) and (not WingDraw) then
              dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1)
            else if ((dir = DR_UP) or (dir = DR_UPLEFT) or (dir = DR_UPRIGHT) or (dir = DR_LEFT) or (dir = DR_RIGHT)) and (WingSurface <> nil) and WingDraw then
              dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1);
        end
        else
        begin
          if ((FocusCret <> nil) or (MagicTarget <> nil)) and ((dir = DR_UP) or (dir = DR_UPLEFT) or (dir = DR_UPRIGHT) or (dir = DR_LEFT) or (dir = DR_RIGHT)) and (WingSurface <> nil) and (not WingDraw) then
            dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1)
          else if ((dir = DR_UP) or (dir = DR_UPLEFT) or (dir = DR_UPRIGHT) or (dir = DR_LEFT) or (dir = DR_RIGHT)) and (WingSurface <> nil) and WingDraw then
            dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1);
        end;
      end;
    end;

// 2锅葛靛 ---------------------------------------------------------------------
      // 50饭骇渴 烙棋飘
    if bShowTrans = 0 then
    begin
    if (Dress in [22, 23]) and Bo50DressHEffect and (WingSurface <> nil) then
      dsurface.DrawBlend(dx + epx + ShiftX, dy + epy + ShiftY, WingSurface, 1);

      // 50Level Effect
    if (Bo50LevelEffect) and (Bo50LevelHEffect) then
      dsurface.DrawBlend(dx + epx2 + ShiftX, dy + epy2 + ShiftY, H50LevelEffectSurface, 1);
    end;

      // Writer Effect
//      if (BoWriterEffect) and (BoWriterHEffect) then
//         DrawBlend (dsurface, dx + epx3 + ShiftX, dy + epy3 + ShiftY, HWriterEffectSurface, 1);
      //林贱狼阜牢 版快
    if state and $00100000{STATE_BUBBLEDEFENCEUP}  <> 0 then
    begin  //林贱狼阜
      if (CurrentAction = SM_STRUCK) and (CurBubbleStruck < 3) then
        idx := MAGBUBBLESTRUCKBASE + CurBubbleStruck
      else
        idx := MAGBUBBLEBASE + (GenAniCount mod 3);
      d := WMagic.GetCachedImage(idx, ax, ay);
      if d <> nil then
        dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);
    end;
         //先天气功
      if State and $00040000{STATE_CELESTIALUP} <> 0 then begin
         if (CurrentAction = SM_STRUCK) and (CurBubbleStruck < 3) then
            idx := CELESTIALSTRUCKBASE + CurBubbleStruck
         else
            idx := CELESTIALBASE + (GenAniCount mod 3);
         d := WMagic2.GetCachedImage (idx, ax, ay);
         if d <> nil then
//            DrawBlend (dsurface,
//                             dx + ax + ShiftX,
//                             dy + ay + ShiftY,
//                             d, 1);
              dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);

      end;
      //血龙剑法
      if State and $00020000{STATE_BLOODDRAGONSWORD} <> 0 then begin
         idx := BLOODDRAGONSWORDBASE + (GenAniCount mod 3);
         d := WMagic3.GetCachedImage (idx, ax, ay);
         if d <> nil then
            dsurface.DrawBlend (
                             dx + ax + ShiftX,
                             dy + ay + ShiftY,
                             d, 1);

      end;
      //---哗哗肺单捞 捞亥飘------------------------------------------------------------------------------
    FoodStickType := 0;
    if RecogId = Myself.RecogId then
    begin
      if (UseItems[U_RIGHTHAND].S.Name <> '') and (UseItems[U_RIGHTHAND].S.Looks = 863) and CouplePower then
      begin
        FoodStickType := 3;
        FoodStickDayEffectOffset := 550;
        FoodStickDayEffectOffset2 := 530;
        BoFoodStickDayEffect := True;
        FoodStickDayEffectFrameTime := 100;
        if FoodStickDayEffectSurface <> nil then
          dsurface.DrawBlend(dx + epx3 + ShiftX, dy + epy3 + ShiftY, FoodStickDayEffectSurface, 1);
        if FoodStickDayEffectSurface2 <> nil then
          dsurface.Draw(dx + epx4 + ShiftX, dy + epy4 + ShiftY, FoodStickDayEffectSurface2.ClientRect, FoodStickDayEffectSurface2, TRUE);
      end
      else if (UseItems[U_RIGHTHAND].S.Name <> '') and (UseItems[U_RIGHTHAND].S.Looks = 863) then
      begin
        FoodStickType := 1;
        if MySelf.Sex = 0 then
        begin
          FoodStickDayEffectOffset := 490;
          FoodStickDayEffectOffset2 := 470;
        end
        else
        begin
          FoodStickDayEffectOffset := 510;
          FoodStickDayEffectOffset2 := 470;
        end;
        BoFoodStickDayEffect := True;
        FoodStickDayEffectFrameTime := 100;
        if FoodStickDayEffectSurface <> nil then
          dsurface.DrawBlend(dx + epx3 + ShiftX, dy + epy3 + ShiftY, FoodStickDayEffectSurface, 1);
        if FoodStickDayEffectSurface2 <> nil then
          dsurface.Draw(dx + epx4 + ShiftX, dy + epy4 + ShiftY, FoodStickDayEffectSurface2.ClientRect, FoodStickDayEffectSurface2, TRUE);
      end
      else if (UseItems[U_RIGHTHAND].S.Name <> '') and (UseItems[U_RIGHTHAND].S.Looks = 918) then
      begin
        FoodStickType := 2;
        FoodStickDayEffectOffset := 440;
        FoodStickDayEffectOffset2 := 420;
        BoFoodStickDayEffect := True;
        FoodStickDayEffectFrameTime := 120;
        if FoodStickDayEffectSurface <> nil then
          dsurface.DrawBlend(dx + epx3 + ShiftX, dy + epy3 + ShiftY, FoodStickDayEffectSurface, 1);
        if FoodStickDayEffectSurface2 <> nil then
          dsurface.Draw(dx + epx4 + ShiftX, dy + epy4 + ShiftY, FoodStickDayEffectSurface2.ClientRect, FoodStickDayEffectSurface2, TRUE);
//               DrawEffSurface (dsurface, FoodStickDayEffectSurface2, dx + epx4 + ShiftX, dy + epy4 + ShiftY, blend, ceNone);
      end;
    end;
//      else FoodStickType := 0;
      //-------------------------------------------------------------------------------------------------

  end;

  if BoHitEffect and (HitEffectNumber = 8) then
  begin
  end
  else
  begin
    if BoUseMagic {and (EffDir[Dir] = 1)}  and (CurMagic.EffectNumber > 0) then
    begin
    if CurMagic.EffectNumber in [62,72,80] then Exit;
      if CurEffFrame in [0..SpellFrame - 1] then
      begin
        GetEffectBase(CurMagic.EffectNumber - 1, 0, wimg, idx);
          if CurMagic.EffectNumber in [56,57,61,63,70] then
         idx := idx + (Dir * 10) + CurEffFrame
         else
        idx := idx + CurEffFrame;
        if wimg <> nil then
          d := wimg.GetCachedImage(idx, ax, ay);
        if d <> nil then
          dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);
      end;
    end;
  end;

   // 傍颇级 喊档 贸府
  if BoHitEffect and (HitEffectNumber = 8) then
  begin
    if GetTickCount - SKillStartTime > SKillFrametime then
    begin
      if SKillCurrentFrame < (14) then
        Inc(SKillCurrentFrame)
      else
      begin
        SKillCurrentFrame := 0;
        BoHitEffect := False;
      end;
      SKillStartTime := GetTickCount;
    end;
    idx := dir * 20;
    wimg := WMagic2;
    if wimg <> nil then
      d := wimg.GetCachedImage((740 + idx) + SKillCurrentFrame, ax, ay);
//      DScreen.AddChatBoardString ('SKillCurrentFrame=>'+IntToStr(SKillCurrentFrame), clYellow, clRed);
    if d <> nil then
      dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);
  end   //八过 瓤苞
  else if BoHitEffect and (HitEffectNumber > 0) then
  begin
    GetEffectBase(HitEffectNumber - 1, 1, wimg, idx);
    idx := idx + dir * 10 + (currentframe - startframe);
    if wimg <> nil then
      d := wimg.GetCachedImage(idx, ax, ay);
    if d <> nil then
      dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);
  end;

   //拱距 冈绊 唱绰 瓤苞
   //if BoEatEffect then begin
   //   if GetTickCount - EatEffectTime > 70 then begin
   //      EatEffectTime := GetTickCount;
   //      Inc (EatEffectFrame);
   //   end;
   //   if EatEffectFrame >= 6 then begin
   //      BoEatEffect := FALSE;
   //      EatEffectFrame := 0;
   //   end;
   //
   //   d := WEffectImg.GetCachedImage (296 + EatEffectFrame, ax, ay);
   //   if d <> nil then
   //      DrawBlend (dsurface,
   //                       dx + ax + ShiftX,
   //                       dy + ay + ShiftY,
   //                       d, 1);
   //end;
   //公扁 氢惑/何辑咙 瓤苞
  if BoWeaponEffect then
  begin
    idx := WPEFFECTBASE + dir * 10 + CurWpEffect;
    d := WMagic.GetCachedImage(idx, ax, ay);
    if d <> nil then
      dsurface.DrawBlend(dx + ax + ShiftX, dy + ay + ShiftY, d, 1);
  end;

end;

end.

